<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>Baby Theremin â€“ Cute Ver.2</title>
<link rel="manifest" href="./manifest.json?v=3.5.6">
<meta name="theme-color" content="#ffffff">
<style>
  :root{ --bg:#fafbfe; --text:#10121a; --panel:#ffffffcc; --shadow:rgba(0,0,0,.12); }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Roboto,"Noto Sans JP",sans-serif;
    overscroll-behavior:none; position:fixed; width:100%;
  }
  #bg {
    position:fixed; inset:0; z-index:0;
    background:
      radial-gradient(circle at 25% 15%, rgba(255,255,255,0.95), rgba(255,255,255,0) 55%),
      radial-gradient(circle at 80% 85%, rgba(240,244,255,0.95), rgba(240,244,255,0) 65%),
      linear-gradient(180deg,#ffffff,#f0f4ff);
  }
  #stage {
    position:fixed; inset:0; width:100vw; height:100vh; z-index:1;
    touch-action:none;
  }
  @supports (height: 100svh) { #stage { height:100svh; } }

  .starter{position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:transparent; z-index:100;
  }
  .starter .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px; padding:22px 18px;
    box-shadow:0 10px 30px rgba(0,0,0,.08); text-align:center; color:#111; max-width:90vw
  }
  .starter .big{font-size:18px; margin-bottom:10px; font-weight:700;}
  .starter .startbtn{appearance:none;border:0;background:#10b981;color:#fff;border-radius:12px;
    padding:14px 22px;font-size:18px;cursor:pointer; width:100%; font-weight:700;
  }
  .small{font-size:12px;color:#6b7280;margin-top:10px; line-height:1.35}

  #songBar{
    position:fixed; left:10px; bottom:10px; z-index:60;
    display:flex; gap:8px; flex-wrap:wrap; max-width:80vw;
  }
  .songBtn{
    width:42px; height:42px; border-radius:999px;
    background:var(--panel);
    backdrop-filter:saturate(1.05) blur(8px);
    border:1px solid #e5e7eb;
    box-shadow:0 10px 22px var(--shadow);
    display:flex; align-items:center; justify-content:center;
    user-select:none; -webkit-user-select:none;
    touch-action:manipulation;
    font-size:20px;
  }
  .songBtn.active{ outline:2px solid #111827; outline-offset:2px; }
  .songBtn:focus-visible{ outline:3px solid #111827; outline-offset:2px; }

  #emojiFallback{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:min(38vw,180px);
    z-index:20; pointer-events:none;
    opacity:0; transition:opacity .2s ease;
    filter: drop-shadow(0 12px 22px rgba(0,0,0,.12));
  }
  #emojiFallback.show{ opacity:1; }
</style>

<script>
/* === Hard update guard (v3.5.6) === */
const APP_VERSION = "3.5.6";
(async () => {
  try {
    const last = localStorage.getItem("babyThereminVersion");
    if (last !== APP_VERSION) {
      localStorage.setItem("babyThereminVersion", APP_VERSION);
      if (navigator.serviceWorker) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
      location.replace("./index.html?v=" + APP_VERSION + "&hard=1");
      return;
    }
  } catch (e) {}
})();
</script>

</head>
<body>
<div id="bg"></div>

<div id="starter" class="starter">
  <div class="card">
    <div class="big">Baby Theremin</div>
    <div>ã‚¯ãƒã¨ã‚«ã‚¨ãƒ«ã‚’<br>ã‚‚ã£ã¨ã‹ã‚ã„ãã—ã¾ã—ãŸ</div>
    <div style="margin-top:12px;">
      <button id="startbtn" class="startbtn">ã¯ã˜ã‚ã‚‹ â–¶</button>
    </div>
    <div class="small">æ›²ã¯è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ v3.5.6</div>
  </div>
</div>

<div id="emojiFallback" aria-hidden="true">â˜†</div>
<svg id="stage" viewBox="0 0 1000 1000" preserveAspectRatio="none" aria-hidden="true">
  <defs>
    <filter id="glow" x="-60%" y="-60%" width="220%" height="220%">
      <feGaussianBlur stdDeviation="6" result="blur"/>
      <feMerge>
        <feMergeNode in="blur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>
</svg>

<div id="songBar" aria-label="æ›²ã‚’ãˆã‚‰ã¶">
  <button class="songBtn" data-song="star" aria-label="ãã‚‰ãã‚‰æ˜Ÿ">â˜†</button>
  <button class="songBtn" data-song="sheep" aria-label="ãƒ¡ãƒªãƒ¼ã•ã‚“ã®ç¾Š">ğŸ‘</button>
  <button class="songBtn" data-song="bear" aria-label="æ£®ã®ãã¾ã•ã‚“">ğŸ»</button>
  <button class="songBtn" data-song="butterfly" aria-label="ã¡ã‚‡ã†ã¡ã‚‡ã†">ğŸ¦‹</button>
  <button class="songBtn" data-song="bee" aria-label="ã¶ã‚“ã¶ã‚“ã¶ã‚“">ğŸ</button>
  <button class="songBtn" data-song="frog" aria-label="ã‹ãˆã‚‹ã®åˆå”±">ğŸ¸</button>
</div>

<script>
(function(){
  const starter = document.getElementById('starter');
  const startbtn = document.getElementById('startbtn');
  const emojiFallback = document.getElementById('emojiFallback');
  const stage = document.getElementById('stage');
  const songButtons = Array.from(document.querySelectorAll('.songBtn'));

  // ===== Stage sizing =====
  let W=1000, H=1000;
  function fitStage(){
    const vw = (window.visualViewport && visualViewport.width) ? visualViewport.width : innerWidth;
    const vh = (window.visualViewport && visualViewport.height) ? visualViewport.height : innerHeight;
    W = 1000;
    H = 1000 * (vh/Math.max(1,vw));
    stage.setAttribute('viewBox', `0 0 ${W} ${H}`);
  }
  fitStage();
  addEventListener('resize', fitStage, {passive:true});
  if(window.visualViewport) visualViewport.addEventListener('resize', fitStage, {passive:true});

  function ptFromEvent(e){
    const r = stage.getBoundingClientRect();
    const x = (e.clientX - r.left) / r.width * W;
    const y = (e.clientY - r.top) / r.height * H;
    return (Number.isFinite(x) && Number.isFinite(y)) ? {x,y} : null;
  }

  // ===== Audio Engine =====
  const AC = window.AudioContext || window.webkitAudioContext;
  let actx=null, analyser=null, master=null, melodyBus=null, thBus=null;
  let thFilter=null, envGain=null, oscA=null, oscB=null, lfoTrem=null, lfoTremGain=null, lfoVib=null, lfoVibGain=null;
  let seqTimer=null, seqPos=0, currentSong=null;

  const chime = new Audio('./Chime.mp3');
  chime.volume = 0.30;

  function ensureAudio(){
    if(actx) return;
    actx = new AC();
    analyser = actx.createAnalyser(); analyser.fftSize = 256;
    master = actx.createGain(); master.gain.value = 0.90;
    melodyBus = actx.createGain(); melodyBus.gain.value = 0.60;
    thBus = actx.createGain(); thBus.gain.value = 0.28;
    melodyBus.connect(analyser); thBus.connect(analyser);
    analyser.connect(master); master.connect(actx.destination);

    // Theremin setup
    envGain = actx.createGain(); envGain.gain.value = 0.0;
    thFilter = actx.createBiquadFilter(); thFilter.type = 'lowpass'; thFilter.frequency.value = 1200;
    oscA = actx.createOscillator(); oscA.type = 'sine';
    oscB = actx.createOscillator(); oscB.type = 'sine'; oscB.detune.value = +6;
    lfoTrem = actx.createOscillator(); lfoTrem.type = 'sine'; lfoTrem.frequency.value = 0.9;
    lfoTremGain = actx.createGain(); lfoTremGain.gain.value = 0.05;
    lfoVib = actx.createOscillator(); lfoVib.type = 'sine'; lfoVib.frequency.value = 5.5;
    lfoVibGain = actx.createGain(); lfoVibGain.gain.value = 7.0;

    oscA.connect(thFilter); oscB.connect(thFilter);
    thFilter.connect(envGain); envGain.connect(thBus);
    lfoVib.connect(lfoVibGain); lfoVibGain.connect(oscA.detune); lfoVibGain.connect(oscB.detune);
    lfoTrem.connect(lfoTremGain); lfoTremGain.connect(envGain.gain);
    oscA.start(); oscB.start(); lfoTrem.start(); lfoVib.start();
  }

  function resumeAudio(){ ensureAudio(); if(actx && actx.state !== 'running') actx.resume(); }
  function n2f(n){ return 440 * Math.pow(2, (n-69)/12); }

  function playNote(n, durSec, vel=1.0){
    if(!actx) return;
    const t0 = actx.currentTime;
    const o = actx.createOscillator(); o.type = 'sine'; o.frequency.value = n2f(n);
    const g = actx.createGain();
    g.gain.setValueAtTime(0, t0);
    g.gain.linearRampToValueAtTime(0.2 * vel, t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+durSec);
    o.connect(g).connect(melodyBus);
    o.start(t0); o.stop(t0 + durSec + 0.1);
  }

  // ===== Songs Data =====
  const SONGS = {
    star: { type:'star', color:'#facc15', tempo:112, icon:'â˜†', seq:[{n:60,d:1},{n:60,d:1},{n:67,d:1},{n:67,d:1},{n:69,d:1},{n:69,d:1},{n:67,d:2},{n:65,d:1},{n:65,d:1},{n:64,d:1},{n:64,d:1},{n:62,d:1},{n:62,d:1},{n:60,d:2}] },
    sheep: { type:'sheep', color:'#60a5fa', tempo:110, icon:'ğŸ‘', seq:[{n:64,d:1.5},{n:62,d:0.5},{n:60,d:1},{n:62,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:2},{n:62,d:1},{n:62,d:1},{n:62,d:2},{n:64,d:1},{n:67,d:1},{n:67,d:2}] },
    bear: { type:'bear', color:'#fb923c', tempo:96, icon:'ğŸ»', seq:[{n:67,d:1},{n:69,d:0.5},{n:71,d:0.5},{n:72,d:1},{n:67,d:1},{n:64,d:1},{n:60,d:1},{n:69,d:2}] },
    butterfly: { type:'butterfly', color:'#a78bfa', tempo:112, icon:'ğŸ¦‹', seq:[{n:67,d:1},{n:64,d:1},{n:64,d:2},{n:65,d:1},{n:62,d:1},{n:62,d:2},{n:60,d:1},{n:62,d:1},{n:64,d:1},{n:65,d:1},{n:67,d:1},{n:67,d:1},{n:67,d:2}] },
    bee: { type:'bee', color:'#f472b6', tempo:126, icon:'ğŸ', seq:[{n:67,d:1},{n:65,d:1},{n:64,d:2},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:62,d:0.5},{n:60,d:2}] },
    frog: { type:'frog', color:'#4ade80', tempo:112, icon:'ğŸ¸', seq:[{n:60,d:1},{n:62,d:1},{n:64,d:1},{n:65,d:1},{n:64,d:1},{n:62,d:1},{n:60,d:2}] }
  };
  const SONG_KEYS = Object.keys(SONGS);

  function startSong(k){
    resumeAudio(); if(seqTimer) clearTimeout(seqTimer);
    currentSong = k; seqPos = 0;
    const song = SONGS[k];
    songButtons.forEach(b=>b.classList.toggle('active', b.dataset.song===k));
    emojiFallback.textContent = song.icon; emojiFallback.classList.add('show');
    resetShapes();

    (function tick(){
      if(!currentSong) return;
      if(seqPos >= song.seq.length){
        seqTimer = setTimeout(()=> startSong(SONG_KEYS[(Math.random()*SONG_KEYS.length)|0]), 2000);
        return;
      }
      const item = song.seq[seqPos];
      const beatSec = 60 / song.tempo;
      if(item.n) playNote(item.n, item.d*beatSec);
      seqPos++;
      seqTimer = setTimeout(tick, item.d*beatSec*1000);
    })();
  }

  // ===== SVG Drawing =====
  const SHAPE_COUNT = 9;
  let shapes = [];
  let t = 0;

  function neonStroke(elem, color){
    const common = { 'fill':'none', 'stroke-linecap':'round', 'stroke-linejoin':'round', 'vector-effect':'non-scaling-stroke' };
    const g1 = elem.cloneNode(false); Object.assign(g1.style, common); 
    g1.setAttribute('stroke', color); g1.setAttribute('stroke-width', '22'); g1.setAttribute('opacity', '0.15'); g1.setAttribute('filter', 'url(#glow)');
    const g2 = elem.cloneNode(false); Object.assign(g2.style, common);
    g2.setAttribute('stroke', color); g2.setAttribute('stroke-width', '12'); g2.setAttribute('opacity', '0.8');
    const g3 = elem.cloneNode(false); Object.assign(g3.style, common);
    g3.setAttribute('stroke', '#fff'); g3.setAttribute('stroke-width', '5');
    return [g1, g2, g3];
  }

  function addPath(g, d, color){
    const p = el('path'); p.setAttribute('d', d);
    neonStroke(p, color).forEach(n => g.appendChild(n));
  }

  function makeCuteAnimal(type, color){
    const g = el('g');
    if(type==='star'){
      addPath(g, 'M 0 -0.9 Q 0.2 -0.3 0.9 -0.2 Q 0.4 0.2 0.6 0.8 Q 0 0.5 -0.6 0.8 Q -0.4 0.2 -0.9 -0.2 Q -0.2 -0.3 0 -0.9 Z', color);
    } else if(type==='bear'){
      // Improved Cute Bear
      addPath(g, 'M -0.9 0.1 Q -0.9 -0.7 0 -0.7 Q 0.9 -0.7 0.9 0.1 Q 0.9 0.8 0 0.8 Q -0.9 0.8 -0.9 0.1 Z', color); // Face
      addPath(g, 'M -0.55 -0.6 Q -0.8 -0.9 -0.4 -1.0', color); // L Ear
      addPath(g, 'M 0.55 -0.6 Q 0.8 -0.9 0.4 -1.0', color);  // R Ear
      addPath(g, 'M -0.4 -0.1 L -0.4 -0.1', color); // Eye
      addPath(g, 'M 0.4 -0.1 L 0.4 -0.1', color);  // Eye
      addPath(g, 'M -0.1 0.2 Q 0 0.3 0.1 0.2', color); // Nose/Mouth
    } else if(type==='frog'){
      // Improved Cute Frog
      addPath(g, 'M -0.9 0.2 Q -0.9 0.8 0 0.8 Q 0.9 0.8 0.9 0.2 Q 0.9 -0.4 0 -0.4 Q -0.9 -0.4 -0.9 0.2', color); // Face
      addPath(g, 'M -0.6 -0.3 Q -0.7 -0.8 -0.3 -0.8 Q 0.1 -0.8 0 -0.3', color); // L Eye Bump
      addPath(g, 'M 0.6 -0.3 Q 0.7 -0.8 0.3 -0.8 Q -0.1 -0.8 0 -0.3', color); // R Eye Bump
      addPath(g, 'M -0.45 -0.5 L -0.45 -0.5', color); // Eye dot
      addPath(g, 'M 0.45 -0.5 L 0.45 -0.5', color);  // Eye dot
      addPath(g, 'M -0.4 0.2 Q 0 0.5 0.4 0.2', color); // Smile
    } else if(type==='sheep'){
      addPath(g, 'M -0.5 0.6 Q -0.9 0.6 -0.9 0.1 Q -1.0 -0.4 -0.4 -0.5 Q -0.1 -0.9 0.3 -0.6 Q 0.8 -0.6 0.9 0.1 Q 0.9 0.6 0.5 0.6', color);
      addPath(g, 'M 0.5 0.1 A 0.2 0.2 0 1 1 0.5 -0.3', color);
    } else if(type==='butterfly'){
      addPath(g, 'M 0 0 Q -0.9 -0.7 -0.8 0.3 Q -0.7 0.8 0 0.1 Q 0.7 0.8 0.8 0.3 Q 0.9 -0.7 0 0', color);
      addPath(g, 'M 0 -0.3 L 0 0.4 M -0.2 -0.5 Q 0 -0.2 0.2 -0.5', color);
    } else if(type==='bee'){
      addPath(g, 'M -0.7 0 Q -0.7 -0.6 0 -0.6 Q 0.7 -0.6 0.7 0 Q 0.7 0.6 0 0.6 Q -0.7 0.6 -0.7 0 Z', color);
      addPath(g, 'M -0.2 -0.6 V 0.6 M 0.2 -0.6 V 0.6 M 0 -0.6 Q 0 -1.1 0.4 -1.1', color);
    }
    return g;
  }

  function el(n){ return document.createElementNS('http://www.w3.org/2000/svg', n); }
  function resetShapes(){
    shapes.forEach(s => stage.removeChild(s.g)); shapes = [];
    const s = SONGS[currentSong];
    for(let i=0; i<SHAPE_COUNT; i++){
      const g = makeCuteAnimal(s.type, s.color); stage.appendChild(g);
      shapes.push({ g, x:Math.random()*W, y:Math.random()*H, r:45, vx:(Math.random()-0.5)*2, vy:(Math.random()-0.5)*2, rot:Math.random()*360 });
    }
  }

  function drawLoop(){
    t++; const pitchScale = 0.5 + (window.visualPitchNorm || 0.5) * 1.5;
    shapes.forEach(s => {
      s.x += s.vx; s.y += s.vy; s.rot += 0.5;
      if(s.x<0 || s.x>W) s.vx *= -1; if(s.y<0 || s.y>H) s.vy *= -1;
      const scale = s.r * pitchScale * (1 + 0.05*Math.sin(t*0.05));
      s.g.setAttribute('transform', `translate(${s.x},${s.y}) rotate(${s.rot}) scale(${scale/40})`);
    });
    requestAnimationFrame(drawLoop);
  }

  // ===== Interaction =====
  let dragging=false;
  stage.addEventListener('pointerdown', (e)=>{
    resumeAudio(); dragging=true; updateTheremin(e);
    const t0 = actx.currentTime; envGain.gain.setTargetAtTime(1.0, t0, 0.05);
  });
  window.addEventListener('pointermove', (e)=>{ if(dragging) updateTheremin(e); });
  window.addEventListener('pointerup', ()=>{
    dragging=false; if(actx) envGain.gain.setTargetAtTime(0, actx.currentTime, 0.1);
    try{ chime.currentTime=0; chime.play(); }catch(e){}
  });

  function updateTheremin(e){
    const p = ptFromEvent(e); if(!p) return;
    const n = Math.min(1, Math.max(0, 1 - p.y/H));
    window.visualPitchNorm = n;
    if(oscA){
      const freq = 130 * Math.pow(820/130, n);
      oscA.frequency.setTargetAtTime(freq, actx.currentTime, 0.02);
      oscB.frequency.setTargetAtTime(freq, actx.currentTime, 0.02);
    }
  }

  startbtn.addEventListener('click', ()=>{ starter.remove(); startSong('star'); requestAnimationFrame(drawLoop); });
  songButtons.forEach(b => b.addEventListener('click', ()=> startSong(b.dataset.song)));
})();
</script>
</body>
</html>