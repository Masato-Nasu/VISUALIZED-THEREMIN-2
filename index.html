<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>Baby Theremin ‚Äì Round Frog Ver.</title>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#ffffff">
<style>
  :root{ --bg:#fafbfe; --text:#10121a; --panel:#ffffffcc; --shadow:rgba(0,0,0,.12); }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Roboto,"Noto Sans JP",sans-serif;
    overscroll-behavior:none; position:fixed; width:100%;
  }
  #bg {
    position:fixed; inset:0; z-index:0;
    background:
      radial-gradient(circle at 25% 15%, rgba(255,255,255,0.95), rgba(255,255,255,0) 55%),
      radial-gradient(circle at 80% 85%, rgba(240,244,255,0.95), rgba(240,244,255,0) 65%),
      linear-gradient(180deg,#ffffff,#f0f4ff);
  }
  #stage {
    position:fixed; inset:0; width:100vw; height:100vh; z-index:1;
    touch-action:none;
  }
  @supports (height: 100svh) { #stage { height:100svh; } }

  .starter{position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:transparent; z-index:100;
  }
  .starter .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px; padding:22px 18px;
    box-shadow:0 10px 30px rgba(0,0,0,.08); text-align:center; color:#111; max-width:90vw
  }
  .starter .big{font-size:18px; margin-bottom:10px; font-weight:700;}
  .starter .startbtn{appearance:none;border:0;background:#10b981;color:#fff;border-radius:12px;
    padding:14px 22px;font-size:18px;cursor:pointer; width:100%; font-weight:700;
  }
  .small{font-size:12px;color:#6b7280;margin-top:10px; line-height:1.35}

  #songBar{
    position:fixed; left:10px; bottom:10px; z-index:60;
    display:flex; gap:8px; flex-wrap:wrap; max-width:80vw;
  }
  .songBtn{
    width:42px; height:42px; border-radius:999px;
    background:var(--panel);
    backdrop-filter:saturate(1.05) blur(8px);
    border:1px solid #e5e7eb;
    box-shadow:0 10px 22px var(--shadow);
    display:flex; align-items:center; justify-content:center;
    user-select:none; -webkit-user-select:none;
    touch-action:manipulation;
    font-size:20px;
  }
  .songBtn.active{ outline:2px solid #111827; outline-offset:2px; }
  .songBtn:focus-visible{ outline:3px solid #111827; outline-offset:2px; }

  #emojiFallback{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:min(38vw,180px);
    z-index:20; pointer-events:none;
    opacity:0; transition:opacity .2s ease;
    filter: drop-shadow(0 12px 22px rgba(0,0,0,.12));
  }
  #emojiFallback.show{ opacity:1; }
</style>

<script>
/* === Hard update guard (v3.5.34) === */
const APP_VERSION = "3.5.22";
(async () => {
  try {
    const last = localStorage.getItem("babyThereminVersion");
    if (last !== APP_VERSION) {
      localStorage.setItem("babyThereminVersion", APP_VERSION);
      if (navigator.serviceWorker) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
      if (window.caches && caches.keys) {
        const keys = await caches.keys();
        await Promise.all(keys.filter(k => k.startsWith("baby-theremin-pd")).map(k => caches.delete(k)));
      }
      location.replace("./index.html?v=" + APP_VERSION + "&hard=1");
      return;
    }
  } catch (e) {}
})();
</script>

<style>#starter{display:none !important; pointer-events:none !important;}</style>
</head>
<body>
<div id="bg"></div>

<div id="starter" class="starter">
  <div class="card">
    <div class="big">Baby Theremin</div>
    <div>„Äå„ÅØ„Åò„ÇÅ„Çã„Äç„ÇíÊäº„Åô„Å®„ÄÅ<br>Êõ≤„Å®ÂΩ¢„Åå„É©„É≥„ÉÄ„É†„ÅßÂßã„Åæ„Çã„Çà</div>
    <div style="margin-top:12px;">
      <button id="startbtn" class="startbtn">„ÅØ„Åò„ÇÅ„Çã ‚ñ∂</button>
    </div>
    <div class="small">Áü≠„Çø„ÉÉ„ÉóÔºö„ÅØ„Åò„Åë„Çã Ôºè Èï∑Êäº„ÅóÔºö„ÉÜ„É´„Éü„É≥<br>„Ç´„Ç®„É´„Çí‰∏∏„Åè„ÄÅÁõÆ„ÇíÁÇπ„Å´„Åó„Åæ„Åó„Åü v3.5.34</div>
  </div>
</div>

<div id="emojiFallback" aria-hidden="true">‚òÜ</div>
<svg id="stage" viewBox="0 0 1000 1000" preserveAspectRatio="none" aria-hidden="true">
  <defs>
    <filter id="glow" x="-60%" y="-60%" width="220%" height="220%">
      <feGaussianBlur stdDeviation="6" result="blur"/>
      <feMerge>
        <feMergeNode in="blur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs></svg>

<div id="songBar" aria-label="Êõ≤„Çí„Åà„Çâ„Å∂">
  <button class="songBtn" data-song="star" aria-label="„Åç„Çâ„Åç„ÇâÊòü">‚òÜ</button>
  <button class="songBtn" data-song="sheep" aria-label="„É°„É™„Éº„Åï„Çì„ÅÆÁæä">üêë</button>
  <button class="songBtn" data-song="bear" aria-label="Ê£Æ„ÅÆ„Åè„Åæ„Åï„Çì">üêª</button>
  <button class="songBtn" data-song="butterfly" aria-label="„Å°„Çá„ÅÜ„Å°„Çá„ÅÜ">ü¶ã</button>
  <button class="songBtn" data-song="bee" aria-label="„Å∂„Çì„Å∂„Çì„Å∂„Çì">üêù</button>
  <button class="songBtn" data-song="frog" aria-label="„Åã„Åà„Çã„ÅÆÂêàÂî±">üê∏</button>
</div>

<script>
(function(){
  const starter = document.getElementById('starter');
  const startbtn = document.getElementById('startbtn');
  const emojiFallback = document.getElementById('emojiFallback');
  const stage = document.getElementById('stage');
  const songButtons = Array.from(document.querySelectorAll('.songBtn'));

  // ===== Stage sizing =====
  let W=1000, H=1000;
  function fitStage(){
    const vw = (window.visualViewport && visualViewport.width) ? visualViewport.width : innerWidth;
    const vh = (window.visualViewport && visualViewport.height) ? visualViewport.height : innerHeight;
    W = 1000;
    H = 1000 * (vh/Math.max(1,vw));
    stage.setAttribute('viewBox', `0 0 ${W} ${H}`);
  }
  fitStage();
  addEventListener('resize', fitStage, {passive:true});
  addEventListener('orientationchange', fitStage, {passive:true});
  if(window.visualViewport) visualViewport.addEventListener('resize', fitStage, {passive:true});

  function ptFromEvent(e){
    const r = stage.getBoundingClientRect();
    const x = (e.clientX - r.left) / r.width * W;
    const y = (e.clientY - r.top) / r.height * H;
    if(Number.isFinite(x) && Number.isFinite(y)) return {x,y};
    return null;
  }

  // ===== Audio =====
  const AC = window.AudioContext || window.webkitAudioContext;
  let actx=null, analyser=null, master=null, melodyBus=null, thBus=null;
  let thFilter=null, envGain=null, oscA=null, oscB=null, lfoTrem=null, lfoTremGain=null, lfoVib=null, lfoVibGain=null;
  let seqTimer=null, seqPos=0, currentSong=null;

  const chime = new Audio('./Chime.mp3');
  chime.volume = 0.0; // disabled

  function ensureAudio(){
    if(actx) return;
    actx = new AC();

    analyser = actx.createAnalyser();
    analyser.fftSize = 256;

    master = actx.createGain(); master.gain.value = 0.90;
    melodyBus = actx.createGain(); melodyBus.gain.value = 0.60;
    thBus = actx.createGain(); thBus.gain.value = 0.28;

    melodyBus.connect(analyser);
    thBus.connect(analyser);
    analyser.connect(master);
    master.connect(actx.destination);

    // --- Music-box-ish ambience ---
    const mbDelay = actx.createDelay(0.45);
    mbDelay.delayTime.value = 0.18;
    const mbWet = actx.createGain();
    mbWet.gain.value = 0.34;
    const mbFb = actx.createGain();
    mbFb.gain.value = 0.18;
    const mbFbLP = actx.createBiquadFilter();
    mbFbLP.type = 'lowpass';
    mbFbLP.frequency.value = 1800;

    mbDelay.connect(mbFbLP);
    mbFbLP.connect(mbFb);
    mbFb.connect(mbDelay);

    melodyBus.connect(mbDelay);
    mbDelay.connect(mbWet);
    mbWet.connect(analyser);

    const noiseLen = Math.floor(actx.sampleRate * 0.03);
    window.__mbNoise = actx.createBuffer(1, noiseLen, actx.sampleRate);
    const ch = window.__mbNoise.getChannelData(0);
    for(let i=0;i<noiseLen;i++){
      const env = Math.pow(1 - i/noiseLen, 2.4);
      ch[i] = (Math.random()*2-1) * env * 0.35;
    }

    // Theremin
    envGain = actx.createGain(); envGain.gain.value = 0.0;

    thFilter = actx.createBiquadFilter();
    thFilter.type = 'lowpass'; thFilter.frequency.value = 1200; thFilter.Q.value = 0.45;

    const thSoftLP = actx.createBiquadFilter();
    thSoftLP.type = 'lowpass';
    thSoftLP.frequency.value = 1400;
    thSoftLP.Q.value = 0.35;

    oscA = actx.createOscillator(); oscA.type = 'sine';
    oscB = actx.createOscillator(); oscB.type = 'sine'; oscB.detune.value = +6;

    lfoTrem = actx.createOscillator(); lfoTrem.type = 'sine'; lfoTrem.frequency.value = 0.9;
    lfoTremGain = actx.createGain(); lfoTremGain.gain.value = 0.05;

    lfoVib = actx.createOscillator(); lfoVib.type = 'sine'; lfoVib.frequency.value = 5.5;
    lfoVibGain = actx.createGain(); lfoVibGain.gain.value = 7.0;

    oscA.connect(thFilter);
    oscB.connect(thFilter);
    thFilter.connect(thSoftLP);
    thSoftLP.connect(envGain);
    envGain.connect(thBus);

    lfoVib.connect(lfoVibGain);
    lfoVibGain.connect(oscA.detune);
    lfoVibGain.connect(oscB.detune);

    lfoTrem.connect(lfoTremGain);
    lfoTremGain.connect(envGain.gain);

    oscA.start(); oscB.start(); lfoTrem.start(); lfoVib.start();
  }

  function resumeAudio(){
    ensureAudio();
    try{ if(actx && actx.state !== 'running') actx.resume(); }catch(_ ){}
  }
  try{ window.__resumeAudio = resumeAudio; }catch(_e){}


  function n2f(n){ return 440 * Math.pow(2, (n-69)/12); }

  function playNote(n, durSec, vel=1.0){
    if(!actx) return;
    const t0 = actx.currentTime;

    const o1 = actx.createOscillator();
    const o2 = actx.createOscillator();
    const o3 = actx.createOscillator();
    o1.type = 'sine';
    o2.type = 'sine';
    o3.type = 'triangle';

    o1.frequency.value = n2f(n);
    o2.frequency.value = n2f(n-12);
    o3.frequency.value = n2f(n);
    o1.detune.value = 0;
    o3.detune.value = 0;

    const mix = actx.createGain();
    mix.gain.value = 1.0;

    const g2 = actx.createGain(); g2.gain.value = 0.20;
    const g3 = actx.createGain(); g3.gain.value = 0.18;

    o1.connect(mix);
    o2.connect(g2).connect(mix);
    o3.connect(g3).connect(mix);

    const g = actx.createGain();
    g.gain.setValueAtTime(0.0, t0);
    g.gain.linearRampToValueAtTime(Math.min(1.0, 0.18 + 0.82*vel), t0+0.008);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+Math.max(0.08, durSec*0.92));

    const hp = actx.createBiquadFilter();
    hp.type = 'highpass';
    hp.frequency.value = 140;

    const lp = actx.createBiquadFilter();
    lp.type = 'lowpass';
    lp.frequency.value = 3200;

    mix.connect(hp).connect(lp).connect(g).connect(melodyBus);

    try{
      if(window.__mbNoise){
        const ns = actx.createBufferSource();
        ns.buffer = window.__mbNoise;
        const ng = actx.createGain();
        ng.gain.setValueAtTime(0.0, t0);
        ng.gain.linearRampToValueAtTime(0.16 + 0.30*vel, t0+0.003);
        ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.03);

        const nhp = actx.createBiquadFilter();
        nhp.type = 'highpass';
        nhp.frequency.value = 900;

        ns.connect(nhp).connect(ng).connect(melodyBus);
        ns.start(t0);
        ns.stop(t0+0.05);
      }
    }catch(_e){}

    o1.start(t0); o2.start(t0); o3.start(t0);
    const stopT = t0 + durSec + 0.04;
    o1.stop(stopT); o2.stop(stopT); o3.stop(stopT);
  }

  // ===== Songs =====
  const SONGS = {
    star: { label:'„Åç„Çâ„Åç„ÇâÊòü', icon:'‚òÜ', tempo:112, meter:4, baseVel:0.92, type:'star', color:'#facc15',
      seq:[{n:60,d:1},{n:60,d:1},{n:67,d:1},{n:67,d:1},{n:69,d:1},{n:69,d:1},{n:67,d:2},{n:65,d:1},{n:65,d:1},{n:64,d:1},{n:64,d:1},{n:62,d:1},{n:62,d:1},{n:60,d:2},{n:67,d:1},{n:67,d:1},{n:65,d:1},{n:65,d:1},{n:64,d:1},{n:64,d:1},{n:62,d:2},{n:67,d:1},{n:67,d:1},{n:65,d:1},{n:65,d:1},{n:64,d:1},{n:64,d:1},{n:62,d:2},{n:60,d:1},{n:60,d:1},{n:67,d:1},{n:67,d:1},{n:69,d:1},{n:69,d:1},{n:67,d:2},{n:65,d:1},{n:65,d:1},{n:64,d:1},{n:64,d:1},{n:62,d:1},{n:62,d:1},{n:60,d:2},{n:null,d:1}] },
    sheep: { label:'„É°„É™„Éº„Åï„Çì„ÅÆÁæä', icon:'üêë', tempo:110, meter:4, baseVel:0.92, type:'sheep', color:'#60a5fa',
      seq:[{n:64,d:1.5},{n:62,d:0.5},{n:60,d:1},{n:62,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:1},{n:null,d:1},{n:62,d:1},{n:62,d:1},{n:62,d:1},{n:null,d:1},{n:64,d:1},{n:67,d:1},{n:67,d:1},{n:null,d:1},{n:64,d:1.5},{n:62,d:0.5},{n:60,d:1},{n:62,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:1},{n:null,d:1},{n:62,d:1},{n:62,d:1},{n:64,d:1.5},{n:62,d:0.5},{n:60,d:4},{n:null,d:1}] },
    bear: { label:'Ê£Æ„ÅÆ„Åè„Åæ„Åï„Çì', icon:'üêª', tempo: 96, meter:4, baseVel:0.90, type:'bear', color:'#34d399',
      seq:[{n:null,d:0.5},{n:67,d:0.5},{n:69,d:0.5},{n:71,d:0.5},{n:72,d:1},{n:67,d:1},{n:64,d:1},{n:60,d:1},{n:69,d:2},{n:null,d:0.5},{n:69,d:0.5},{n:71,d:0.5},{n:69,d:0.5},{n:67,d:1},{n:68,d:1},{n:69,d:1},{n:71,d:1},{n:72,d:2},{n:null,d:0.5},{n:67,d:0.5},{n:66,d:0.5},{n:67,d:0.5},{n:64,d:1},{n:null,d:1},{n:null,d:0.5},{n:64,d:0.5},{n:63,d:0.5},{n:64,d:0.5},{n:60,d:1},{n:null,d:1},{n:null,d:0.5},{n:64,d:0.5},{n:62,d:0.5},{n:60,d:0.5},{n:62,d:1},{n:null,d:1},{n:null,d:0.5},{n:67,d:0.5},{n:69,d:0.5},{n:67,d:0.5},{n:64,d:1},{n:null,d:1},{n:null,d:0.5},{n:67,d:0.5},{n:69,d:0.5},{n:71,d:0.5},{n:72,d:1},{n:67,d:1},{n:64,d:1},{n:60,d:1},{n:69,d:2},{n:null,d:0.5},{n:69,d:0.5},{n:71,d:0.5},{n:69,d:0.5},{n:67,d:1},{n:65,d:1},{n:64,d:1},{n:62,d:1},{n:60,d:4},{n:null,d:1}] },
    butterfly: { label:'„Å°„Çá„ÅÜ„Å°„Çá„ÅÜ', icon:'ü¶ã', tempo:112, meter:4, baseVel:0.90, type:'butterfly', color:'#a78bfa',
      seq:[{n:67,d:1},{n:64,d:1},{n:64,d:2},{n:null,d:0.25},{n:65,d:1},{n:62,d:1},{n:62,d:2},{n:60,d:1},{n:62,d:1},{n:64,d:1},{n:65,d:1},{n:67,d:1},{n:67,d:1},{n:67,d:2},{n:67,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:1},{n:65,d:1},{n:62,d:1},{n:62,d:1},{n:62,d:1},{n:60,d:1},{n:64,d:1},{n:67,d:1},{n:67,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:2},{n:62,d:1},{n:62,d:1},{n:62,d:1},{n:62,d:1},{n:62,d:1},{n:64,d:1},{n:65,d:2},{n:64,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:1},{n:65,d:1},{n:67,d:2},{n:67,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:1},{n:65,d:1},{n:62,d:1},{n:62,d:2},{n:60,d:1},{n:64,d:1},{n:67,d:1},{n:67,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:2},{n:null,d:1}] },
    bee: { label:'„Å∂„Çì„Å∂„Çì„Å∂„Çì', icon:'üêù', tempo:126, meter:4, baseVel:0.90, type:'bee', color:'#f472b6',
      seq:[{n:67,d:1},{n:65,d:1},{n:64,d:1},{n:null,d:1},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:62,d:0.5},{n:60,d:1},{n:null,d:1},{n:64,d:0.5},{n:65,d:0.5},{n:67,d:0.5},{n:64,d:0.5},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:67,d:0.5},{n:64,d:0.5},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:62,d:0.5},{n:67,d:1},{n:65,d:1},{n:64,d:1},{n:null,d:1},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:62,d:0.5},{n:60,d:1},{n:null,d:1},{n:null,d:1}] },
    frog: { label:'„Åã„Åà„Çã„ÅÆÂêàÂî±', icon:'üê∏', tempo:112, meter:4, baseVel:0.90, type:'frog', color:'#60a5fa',
      seq:[{n:60,d:1},{n:62,d:1},{n:64,d:1},{n:65,d:1},{n:64,d:1},{n:62,d:1},{n:60,d:2},{n:64,d:1},{n:65,d:1},{n:67,d:1},{n:69,d:1},{n:67,d:1},{n:65,d:1},{n:64,d:2},{n:60,d:1},{n:null,d:1},{n:60,d:1},{n:null,d:1},{n:60,d:1},{n:null,d:1},{n:60,d:1},{n:null,d:1},{n:60,d:0.5},{n:60,d:0.5},{n:62,d:0.5},{n:62,d:0.5},{n:64,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:65,d:0.5},{n:64,d:1},{n:62,d:1},{n:60,d:2},{n:null,d:1}] },
  };
  const SONG_KEYS = Object.keys(SONGS);

  function stopSong(){ if(seqTimer){ clearTimeout(seqTimer); seqTimer=null; } seqPos=0; }
  function setActiveButton(k){ songButtons.forEach(b=>b.classList.toggle('active', b.dataset.song===k)); }
  function updateEmoji(){ const ic = SONGS[currentSong]?.icon || '‚òÜ'; emojiFallback.textContent = ic; emojiFallback.classList.add('show'); }

  function startSong(k){
    resumeAudio();
    // If audio context is still locked (no user gesture yet), don't schedule notes now.
    // Instead, remember the intended song and start it once audio is unlocked.
    try {
      if (actx && actx.state !== 'running') {
        window.__pendingSongStart = k;
        currentSong = k;
        setActiveButton(k);
        updateEmoji();
        resetShapes();
        return;
      }
    } catch(_e){}
    stopSong();
    currentSong = k;
    setActiveButton(k);
    updateEmoji();
    resetShapes();

    const song = SONGS[k];
    const beatSec = 60 / song.tempo;
    const meter = song.meter || 4;
    const baseVel = (song.baseVel==null) ? 0.90 : song.baseVel;

    let beatInBar = 0;

    (function tick(){
      if(!currentSong) return;

      if(seqPos >= song.seq.length){
        // Change song automatically
        seqTimer = setTimeout(()=>{
          randomStart();
        }, beatSec * 2000);
        return;
      }

      const item = song.seq[seqPos];
      const beats = (item.d||1);
      const dur = beats * beatSec;

      const velAuto = 1.0;
      const vel = Math.max(0.35, Math.min(1.20, baseVel * (item.v ?? velAuto)));

      if(item.n!=null) playNote(item.n, dur*0.98, vel);

      beatInBar += beats;
      while(beatInBar >= meter) beatInBar -= meter;

      seqPos++;
      seqTimer = setTimeout(tick, Math.max(20, dur*1000));
    })();
  }
  try{ window.__startSong = startSong; }catch(_e){}

  function randomStart(){ startSong(SONG_KEYS[(Math.random()*SONG_KEYS.length)|0]); }

  // ===== SVG neon (Tracing Style) =====
  const MIN_DIM = Math.min(innerWidth, innerHeight);
  const IS_MOBILE = MIN_DIM < 720;
  const SHAPE_COUNT = IS_MOBILE ? 6 : 9;
  const LINE_BASE = Math.max(2, Math.round((IS_MOBILE ? MIN_DIM : Math.min(MIN_DIM, 1000)) * 0.0045));
 
  const BEAT_AMT = 0.14;
  let shapes = [];
  let t=0;
  window.visualPitchNorm = window.visualPitchNorm ?? 0.5;

  function el(name){ return document.createElementNS('http://www.w3.org/2000/svg', name); }

  function neonStroke(elem, color, wGlow, wMid, wCore){
    const g1 = elem.cloneNode(false);
    g1.setAttribute('stroke', color);
    g1.setAttribute('stroke-width', String(wGlow));
    g1.setAttribute('opacity','0.18');
    g1.setAttribute('fill','none');
    g1.setAttribute('stroke-linecap','round');
    g1.setAttribute('stroke-linejoin','round');
    g1.setAttribute('vector-effect','non-scaling-stroke');
    g1.setAttribute('filter','url(#glow)');

    const g2 = elem.cloneNode(false);
    g2.setAttribute('stroke', color);
    g2.setAttribute('stroke-width', String(wMid));
    g2.setAttribute('opacity','0.85');
    g2.setAttribute('fill','none');
    g2.setAttribute('stroke-linecap','round');
    g2.setAttribute('stroke-linejoin','round');
    g2.setAttribute('vector-effect','non-scaling-stroke');

    const g3 = elem.cloneNode(false);
    g3.setAttribute('stroke', '#ffffff');
    g3.setAttribute('stroke-width', String(wCore));
    g3.setAttribute('opacity','0.95');
    g3.setAttribute('fill','none');
    g3.setAttribute('stroke-linecap','round');
    g3.setAttribute('stroke-linejoin','round');
    g3.setAttribute('vector-effect','non-scaling-stroke');

    return [g1,g2,g3];
  }

  function addPath(g, d, color){
    const p = el('path');
    p.setAttribute('d', d);
    const [a,b,c] = neonStroke(p, color, LINE_BASE*2.4, LINE_BASE*1.5, Math.max(1, LINE_BASE*0.65));
    g.appendChild(a); g.appendChild(b); g.appendChild(c);
  }
  function addCircle(g, cx, cy, r, color){
    const p = el('circle');
    p.setAttribute('cx', String(cx));
    p.setAttribute('cy', String(cy));
    p.setAttribute('r', String(r));
    const [a,b,c] = neonStroke(p, color, LINE_BASE*2.4, LINE_BASE*1.5, Math.max(1, LINE_BASE*0.65));
    g.appendChild(a); g.appendChild(b); g.appendChild(c);
  }

  // === TRACING HAND-DRAWN SKETCH (Strict) ===
  function makeCuteAnimal(type, color){
    const g = el('g');

    if(type==='star'){
      // Rounded chubby star (keep)
      addPath(g, 'M 0 -0.95 Q 0.2 -0.4 0.9 -0.3 Q 0.4 0.1 0.6 0.85 Q 0 0.5 -0.6 0.85 Q -0.4 0.1 -0.9 -0.3 Q -0.2 -0.4 0 -0.95 Z', color);
      addPath(g, 'M -0.25 -0.05 L -0.25 -0.05', color); 
      addPath(g, 'M 0.25 -0.05 L 0.25 -0.05', color);
      return g;
    }

    if(type==='sheep'){
      // [‰øÆÊ≠£] ‰ΩìÔºàÈõ≤Ôºâ„ÅÆÂ∑¶Á´Ø„Åã„Çâ„ÄåU„ÅÆÂ≠ó„ÅÆÈ°î„Äç„ÅåÁ™Å„ÅçÂá∫„Å¶„ÅÑ„ÇãÊßãÈÄ†„ÇíÂÜçÁèæ
      // Body: Cloud shape, flat bottom
      addPath(g, 'M -0.5 0.5 Q -0.85 0.5 -0.85 0.2 Q -0.9 -0.2 -0.6 -0.5 Q -0.3 -0.7 0.0 -0.6 Q 0.4 -0.7 0.7 -0.5 Q 1.0 -0.3 0.9 0.1 Q 0.9 0.5 0.5 0.55 L -0.5 0.5', color);
      // Face: Protruding U-shape on the left side
      addPath(g, 'M -0.85 0.05 C -1.1 0.05 -1.15 0.35 -0.85 0.35', color);
      // Face details
      addCircle(g, -0.95, 0.15, 0.02, color); // Eye dot
      // Legs: 4 sticks
      addPath(g, 'M -0.4 0.5 L -0.45 0.8', color);
      addPath(g, 'M -0.15 0.55 L -0.15 0.85', color);
      addPath(g, 'M 0.3 0.55 L 0.3 0.85', color);
      addPath(g, 'M 0.55 0.5 L 0.6 0.8', color);
      return g;
    }

    if(type==='bear'){
      // Head: Circle, slightly wider at bottom
      addPath(g, 'M 0 -0.8 C 0.6 -0.8 0.9 -0.4 0.9 0.1 C 0.9 0.6 0.5 0.95 0 0.95 C -0.5 0.95 -0.9 0.6 -0.9 0.1 C -0.9 -0.4 -0.6 -0.8 0 -0.8', color);
      // Ears: Semicircles
      addPath(g, 'M -0.6 -0.65 C -0.9 -0.9 -0.4 -1.1 -0.35 -0.7', color);
      addPath(g, 'M 0.6 -0.65 C 0.9 -0.9 0.4 -1.1 0.35 -0.7', color);
      // Face: Dots and nose line
      addCircle(g, -0.3, -0.1, 0.02, color); // Eye
      addCircle(g, 0.3, -0.1, 0.02, color); // Eye
      addCircle(g, 0, 0.2, 0.03, color); // Nose
      addPath(g, 'M 0 0.23 L 0 0.5', color);
      addPath(g, 'M -0.2 0.5 Q 0 0.6 0.2 0.5', color);
      return g;
    }

    if(type==='butterfly'){
      // Body: Long thin oval
      addPath(g, 'M 0 -0.6 C -0.1 -0.6 -0.1 0.6 0 0.6 C 0.1 0.6 0.1 -0.6 0 -0.6', color);
      // Head
      addCircle(g, 0, -0.7, 0.12, color);
      // Wings: B shaped
      addPath(g, 'M -0.1 -0.4 C -1.0 -0.8 -1.2 0.4 -0.1 0.2 C -1.0 0.5 -0.6 1.0 -0.1 0.5', color);
      addPath(g, 'M 0.1 -0.4 C 1.0 -0.8 1.2 0.4 0.1 0.2 C 1.0 0.5 0.6 1.0 0.1 0.5', color);
      // Face details
      addCircle(g, -0.04, -0.72, 0.015, color);
      addCircle(g, 0.04, -0.72, 0.015, color);
      addPath(g, 'M -0.04 -0.68 Q 0 -0.65 0.04 -0.68', color);
      // Antennae
      addPath(g, 'M -0.05 -0.8 L -0.15 -1.0', color);
      addPath(g, 'M 0.05 -0.8 L 0.15 -1.0', color);
      return g;
    }

    if(type==='bee'){
      // Head (Circle) + Body (Oval with stripes)
      addCircle(g, -0.5, 0, 0.3, color); // Head
      addPath(g, 'M -0.3 0.1 C -0.3 -0.4 0.5 -0.4 0.6 0.1 C 0.6 0.5 -0.1 0.5 -0.3 0.1', color); // Body
      // Stripes
      addPath(g, 'M -0.1 -0.15 L -0.1 0.35', color);
      addPath(g, 'M 0.15 -0.15 L 0.15 0.35', color);
      addPath(g, 'M 0.4 -0.1 L 0.4 0.25', color);
      // Stinger
      addPath(g, 'M 0.6 0.1 L 0.8 0.1', color);
      // Wings: Upright
      addPath(g, 'M -0.15 -0.15 C -0.2 -0.8 0.1 -0.9 0.2 -0.15', color);
      addPath(g, 'M 0.2 -0.15 C 0.3 -0.7 0.5 -0.7 0.45 -0.15', color);
      // Face
      addCircle(g, -0.6, -0.05, 0.02, color);
      addPath(g, 'M -0.65 0.1 Q -0.55 0.2 -0.45 0.1', color);
      // Legs
      addPath(g, 'M -0.1 0.35 L -0.15 0.6', color);
      addPath(g, 'M 0.1 0.35 L 0.1 0.6', color);
      return g;
    }

    if(type==='frog'){
       // [ÂÜç‰øÆÊ≠£] „ÇÇ„Å£„Å®‰∏∏„Å£„Åì„Åè„ÄÅÁõÆ„ÅØÁÇπ
       // Ëº™ÈÉ≠: ÂÖ®‰ΩìÁöÑ„Å´‰∏∏„ÅÑ„Éï„Ç©„É´„É†„Å´Â§âÊõ¥„ÄÇÁõÆ„ÅÆÁ™ÅËµ∑„ÅØ„Å™„Å†„Çâ„Åã„Å´„ÄÇ
       addPath(g, 'M -0.8 0.1 C -0.8 -0.4 -0.6 -0.6 -0.4 -0.6 C -0.4 -0.8 -0.1 -0.8 -0.1 -0.6 L 0.1 -0.6 C 0.1 -0.8 0.4 -0.8 0.4 -0.6 C 0.6 -0.6 0.8 -0.4 0.8 0.1 C 0.8 0.6 0.5 0.9 0 0.9 C -0.5 0.9 -0.8 0.6 -0.8 0.1', color);
       // ÁõÆ: „Ç∑„É≥„Éó„É´„Å™ÁÇπÔºàÂ∞è„Åï„Å™Â°ó„Çä„Å§„Å∂„ÅóÂÜÜÔºâ
       addCircle(g, -0.25, -0.6, 0.03, color);
       addCircle(g, 0.25, -0.6, 0.03, color);
       // Âè£: ‰ΩçÁΩÆ„ÇíË™øÊï¥
       addPath(g, 'M -0.3 0.3 Q 0 0.5 0.3 0.3', color);
       return g;
    }

    // fallback
    addPath(g, 'M 0 -0.8 L 0.2 -0.2 L 0.8 -0.2 L 0.3 0.2 L 0.5 0.8 L 0 0.4 L -0.5 0.8 L -0.3 0.2 L -0.8 -0.2 L -0.2 -0.2 Z', color);
    return g;
  }
  // ==================================================

  function clearStageButDefs(){
    const kids = Array.from(stage.childNodes);
    for(const k of kids){
      if(k.nodeType===1 && k.nodeName.toLowerCase()==='defs') continue;
      stage.removeChild(k);
    }
  }

  function resetShapes(){
    shapes.length = 0;
    clearStageButDefs();

    const song = SONGS[currentSong] || SONGS.star;
    const type = song.type || 'star';
    const color = song.color || '#60a5fa';

    for(let i=0;i<SHAPE_COUNT;i++){
      const r = (IS_MOBILE ? (MIN_DIM*0.18) : 34) * (0.80+Math.random()*0.80); // base size (mobile bigger)
      const x = Math.random()*W;
      const y = Math.random()*H;
      const rot = Math.random()*Math.PI*2;
      const vx = (Math.random()-0.5)*0.55;
      const vy = (Math.random()-0.5)*0.55;

      const g = makeCuteAnimal(type, color);
      stage.appendChild(g);
      shapes.push({type,color,x,y,r,rot,vx,vy,pulse:0,g});
    }
    emojiFallback.classList.remove('show');
  }

  function burstAt(px,py){
    for(const s of shapes){
      const ang = Math.atan2(s.y-py, s.x-px);
      const f = 4.0 + Math.random()*2.6;
      s.vx += Math.cos(ang)*f;
      s.vy += Math.sin(ang)*f;
      s.pulse = Math.min(1.3, s.pulse+1.0);
    }
  }

  function getBeatScale(){
    if(!analyser) return 1.0;
    const data = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);
    let sum = 0;
    for(let i=0;i<10;i++) sum += data[i] || 0;
    const beatVal = (sum/10) / 255;
    return 1.0 + beatVal * BEAT_AMT;
  }

  function drawLoop(){
    const beatScale = getBeatScale();
    const pnTarget = Math.min(1, Math.max(0, window.visualPitchNorm ?? 0.5));
    window.__pnSmooth = (window.__pnSmooth==null) ? pnTarget : (window.__pnSmooth + (pnTarget - window.__pnSmooth)*0.12);
    const pn = window.__pnSmooth;
    const pitchScale = 0.25 + pn*1.75;

    for(const s of shapes){
      s.x += s.vx; s.y += s.vy; s.rot += 0.006;
      const rr = s.r;
      if(s.x<rr){ s.x=rr; s.vx=Math.abs(s.vx); }
      if(s.x>W-rr){ s.x=W-rr; s.vx=-Math.abs(s.vx); }
      if(s.y<rr){ s.y=rr; s.vy=Math.abs(s.vy); }
      if(s.y>H-rr){ s.y=H-rr; s.vy=-Math.abs(s.vy); }
      s.vx *= 0.992; s.vy *= 0.992;

      const base = 1 + 0.06*Math.sin(t*0.03 + s.x*0.003) + s.pulse*0.22;
      const size = s.r * base * beatScale * pitchScale;
      s.pulse *= 0.92;

      const tx = s.x, ty = s.y;
      const rotDeg = (s.rot * 180/Math.PI).toFixed(2);
      s.g.setAttribute('transform', `translate(${tx.toFixed(2)},${ty.toFixed(2)}) rotate(${rotDeg}) scale(${size.toFixed(3)})`);
    }
    t++;
    requestAnimationFrame(drawLoop);
  }

  // ===== Interaction =====
  let dragging=false, thereminOn=false, holdId=null, lastPos=null;
  window.pitchHz = 440;

  function setPitchFromY(y){
    const pmin=130, pmax=820;
    const n = Math.min(1, Math.max(0, 1 - (y / H)));
    window.pitchHz = pmin * Math.pow(pmax/pmin, n);
    window.visualPitchNorm = n;

    if(actx && oscA && oscB){
      const t0 = actx.currentTime;
      oscA.frequency.setTargetAtTime(window.pitchHz, t0, 0.02);
      oscB.frequency.setTargetAtTime(window.pitchHz, t0, 0.02);
    }
    if(actx && thFilter){
      const t0 = actx.currentTime;
      thFilter.frequency.setTargetAtTime(900 + n*1100, t0, 0.06);
    }
  }

  function startTheremin(){
    if(!actx) return;
    thereminOn = true;
    const t0 = actx.currentTime;
    envGain.gain.cancelScheduledValues(t0);
    envGain.gain.setTargetAtTime(1.0, t0, 0.06);
  }
  function stopTheremin(){
    if(!actx) return;
    thereminOn = false;
    const t0 = actx.currentTime;
    envGain.gain.cancelScheduledValues(t0);
    envGain.gain.setTargetAtTime(0.0, t0, 0.16);
  }

  function pluck(){
    if(!actx) return;
    const now = actx.currentTime;
    const o = actx.createOscillator();
    const g = actx.createGain();
    const lp = actx.createBiquadFilter();
    o.type = 'triangle';
    lp.type = 'lowpass'; lp.frequency.value = 2400;
    o.frequency.value = window.pitchHz || 440;
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.9, now+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.28);
    o.connect(lp).connect(g).connect(master);
    o.start(now);
    o.stop(now+0.4);
  }

  stage.addEventListener('pointerdown', (e)=>{
    resumeAudio();
    dragging=true;
    lastPos = ptFromEvent(e);
    if(lastPos) setPitchFromY(lastPos.y); 
    if(holdId) clearTimeout(holdId);
    holdId = setTimeout(()=>{
      if(lastPos) setPitchFromY(lastPos.y);
      startTheremin();
    }, 220);
  }, {passive:false});

  stage.addEventListener('pointermove', (e)=>{
    if(!dragging) return;
    const p = ptFromEvent(e);
    if(p){
      lastPos = p;
      setPitchFromY(p.y); 
    }
  }, {passive:false});

  window.addEventListener('pointerup', (e)=>{
    if(!dragging) return;
    dragging=false;
    if(holdId){ clearTimeout(holdId); holdId=null; }
    if(thereminOn){ stopTheremin(); }
    else {
      if(suppressTapSfx){
        suppressTapSfx=false;
      } else {
        pluck();
        /* open chime disabled */
        const p = ptFromEvent(e) || lastPos;
        if(p) burstAt(p.x,p.y);
      }
    }
  }, {passive:false});

  let started=false;
  let suppressTapSfx=false; // skip tap SFX once (first unlock tap)
  function startApp(){
    if(started) return;
    started=true;
    if(starter && starter.parentNode) starter.parentNode.removeChild(starter);
    randomStart();
    resetShapes();
    requestAnimationFrame(drawLoop);
  }
  try{ window.__startApp = startApp; }catch(_e){}

  // v3.5.34 patch: start on first touch anywhere (no button required)
  const __startOnGesture = (e)=>{ try{ if(!started){ suppressTapSfx=true; startApp(); } else { resumeAudio(); } }catch(_err){} };
  window.addEventListener('pointerdown', __startOnGesture, {once:true, passive:true, capture:true});
  window.addEventListener('touchstart', __startOnGesture, {once:true, passive:true, capture:true});
  window.addEventListener('mousedown', __startOnGesture, {once:true, passive:true, capture:true});



  if(startbtn){ startbtn.addEventListener('click', (e)=>{ e.stopPropagation(); startApp(); }); }

  songButtons.forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      if(!started) startApp();
      if(btn.dataset.song !== currentSong){ startSong(btn.dataset.song); }
      // if same song, do nothing (avoid unintended restart)
      resetShapes();
});
  });
})();
</script>
<script>
if("serviceWorker" in navigator){  }
</script>

<!-- patch v3.5.34: hide starter, robust start, error overlay -->
<div id="verTag" style="position:fixed;right:10px;bottom:10px;font:12px/1 system-ui;color:#00000055;z-index:9999;user-select:none;pointer-events:none;">
  v3.5.34
</div>
<script>
(() => {
  // --- Error overlay (so "white screen" shows the real cause) ---
  const panel = document.createElement('pre');
  panel.id = 'errPanel';
  panel.style.cssText = 'position:fixed;left:12px;top:12px;right:12px;max-height:45vh;overflow:auto;white-space:pre-wrap;'+
    'background:rgba(255,255,255,.92);backdrop-filter:blur(10px);border:1px solid rgba(0,0,0,.08);'+
    'box-shadow:0 14px 30px rgba(0,0,0,.12);padding:10px 12px;border-radius:16px;'+
    'font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;'+
    'color:#111827;z-index:10000;display:none;';
  document.body.appendChild(panel);

  function showErr(msg) {
    panel.style.display = 'block';
    panel.textContent = '‚ö† „Ç®„É©„ÉºË°®Á§∫ (v3.5.34)\n' + msg;
  }

  window.addEventListener('error', (e) => {
    showErr((e.message || 'Unknown error') + '\n' + (e.filename||'') + ':' + (e.lineno||0) + ':' + (e.colno||0));
  });
  window.addEventListener('unhandledrejection', (e) => {
    const r = e.reason;
    const msg = (r && (r.stack || r.message)) ? (r.stack || r.message) : String(r);
    showErr('Unhandled Promise rejection\n' + msg);
  });

  // --- Keep starter in DOM but hidden; also expose a global 'starter' in case code expects it ---
  const s = document.getElementById('starter');
  if (s) {
    s.style.display = 'none';
    s.style.pointerEvents = 'none';
    window.starter = s;
  }

  // --- SW register (versioned) ---
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(console.warn);
  }

  // --- Safe starter: start visuals once on load, unlock audio on first gesture (no restart) ---
  let __didStartApp = false;

  function startVisualsOnce(){
    if(__didStartApp) return;
    try {
      if (typeof window.__startApp === 'function') {
        window.__startApp();
        __didStartApp = true;
      } else {
        const b = document.getElementById('startbtn') || document.querySelector('#starter button, button#start, button[data-start]');
        if (b) { b.click(); __didStartApp = true; }
      }
    } catch (err) {
      const msg = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
      showErr(msg);
    }
  }

  function unlockAudioOnly(){
    try {
      if (typeof window.__resumeAudio === 'function') window.__resumeAudio();
      // If we deferred melody start due to audio lock, start it now exactly once.
      if (window.__pendingSongStart && typeof window.__startSong === 'function') {
        const k = window.__pendingSongStart;
        window.__pendingSongStart = null;
        window.__startSong(k);
      }
    } catch (err) {

      const msg = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
      showErr(msg);
    }
  }

  window.addEventListener('load', () => {
    // Start visuals immediately (do not depend on gesture). Audio may stay locked until first tap.
    startVisualsOnce();
  }, { once:true });

  const onceGesture = () => {
    // IMPORTANT: do NOT call startApp again here (it restarts the melody).
    unlockAudioOnly();
    window.removeEventListener('pointerdown', onceGesture, true);
    window.removeEventListener('touchstart', onceGesture, true);
    window.removeEventListener('mousedown', onceGesture, true);
  };
  window.addEventListener('pointerdown', onceGesture, true);
  window.addEventListener('touchstart', onceGesture, true);
  window.addEventListener('mousedown', onceGesture, true);
})();
</script>


<script>
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  window.__deferredInstallPrompt = e;
});
</script>

</body>
</html>