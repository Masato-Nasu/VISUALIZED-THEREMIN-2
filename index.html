<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>Baby Theremin Animals</title>
<link rel="manifest" href="./manifest.json?v=3.1.0">
<meta name="theme-color" content="#ffffff">
<style>
  :root{ --bg:#fafbfe; --panel:#ffffffcc; --text:#10121a; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Roboto,"Noto Sans JP",sans-serif; overscroll-behavior:none; position:fixed; width:100%; }
  #app{ position:fixed; inset:0; }
  .starter{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,#ffffff,#f0f4ff); z-index:100;}
  .starter .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px; padding:22px 18px; box-shadow:0 10px 30px rgba(0,0,0,.08); text-align:center; color:#111; max-width:90vw}
  .starter .big{font-size:18px; margin-bottom:10px; font-weight:bold;}
  .starter .startbtn{appearance:none;border:0;background:#10b981;color:#fff;border-radius:12px;padding:14px 22px;font-size:18px;cursor:pointer; width:100%; font-weight:bold;}
  .small{font-size:12px;color:#6b7280;margin-top:10px}
  .controls{ position:fixed; left:0; right:0; bottom:0; padding:12px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center;
    background:#ffffffcc; backdrop-filter:saturate(1.05) blur(8px); border-top-left-radius:16px; border-top-right-radius:16px;
    transition:opacity .2s ease, visibility .2s ease, transform .2s ease; transform:translateY(8px); z-index:50;}
  .controls.hidden{ opacity:0; visibility:hidden; pointer-events:none; transform:translateY(12px) }
  .btn{appearance:none;border:0;border-radius:14px;background:#2f6feb;color:#fff; padding:12px 16px;font-size:16px;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .range,.select{display:inline-flex;align-items:center;gap:10px;background:#0f1117; color:#E8EAF2; border-radius:14px;padding:10px 12px; box-shadow:0 2px 8px rgba(0,0,0,.2)}
  input[type="range"]{width:160px}
  select{background:transparent;color:#E8EAF2;border:1px solid #222;padding:8px 10px;border-radius:10px}
  .visually-hidden{ position:absolute; left:-9999px; width:1px; height:1px; opacity:0; }

#starter{display:none !important;}
</style>
</head>
<body>
<div id="app">
  <div id="starter" class="starter">
    <div class="card">
      <div class="big">ğŸ¶ Baby Theremin Animals ğŸ˜</div>
      <div>ã€Œã¯ã˜ã‚ã‚‹ã€ã‚’æŠ¼ã™ã¨ã€<br>ã©ã†ã¶ã¤ã®æ›²ãŒãƒ©ãƒ³ãƒ€ãƒ ã§æµã‚Œã‚‹ã‚ˆï¼</div>
      <div style="margin-top:12px;">
        <button id="startbtn" class="startbtn">ã¯ã˜ã‚ã‚‹ â–¶</button>
      </div>
      <div class="small">çŸ­ã‚¿ãƒƒãƒ—ï¼šã¯ã˜ã‘ã‚‹ ï¼ é•·æŠ¼ã—ï¼šãƒ†ãƒ«ãƒŸãƒ³<br>ï¼ˆ2æœ¬æŒ‡é•·æŠ¼ã—ã§è¨­å®šãƒ‘ãƒãƒ«ï¼‰v3.1</div>
    </div>
  </div>
</div>

<div class="controls hidden" id="controls">
  <label class="btn" id="dirBtn">ğŸµ éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«<input id="audDir" type="file" multiple accept="audio/*" class="visually-hidden"></label>
  <div class="select">ğŸ¶ æ›²ãƒ»ã©ã†ã¶ã¤
    <select id="preset">
      <option value="none">ï¼ˆãªã—ãƒ»ãƒŸãƒƒã‚¯ã‚¹ï¼‰</option>
      <option value="dog">ã„ã¬ã®ãŠã¾ã‚ã‚Šã•ã‚“</option>
      <option value="bear">æ£®ã®ãã¾ã•ã‚“</option>
      <option value="elephant">ãã†ã•ã‚“</option>
    </select>
  </div>
  <button id="prev" class="btn">â† ã¾ãˆ</button>
  <button id="play" class="btn">â–¶ / âšâš</button>
  <button id="next" class="btn">ã¤ã â†’</button>
  <div class="range">BGMéŸ³é‡ <input id="bgm" type="range" min="0" max="1" step="0.01" value="0.7"></div>
  <div class="range">ãƒ†ãƒ«ãƒŸãƒ³éŸ³é‡ <input id="tvol" type="range" min="0" max="1" step="0.01" value="0.4"></div>
  <div class="range">ã‹ãš <input id="count" type="range" min="5" max="60" step="1" value="26"></div>
  <div class="range">ã›ã‚“ã®å¤ªã• <input id="thick" type="range" min="2" max="16" step="1" value="7"></div>
  <div class="range">ã²ã‹ã‚Š <input id="glow" type="range" min="10" max="70" step="1" value="44"></div>
  <div class="range">ãƒ“ãƒ¼ãƒˆåå¿œ<input id="beatAmt" type="range" min="0" max="0.5" step="0.01" value="0.18"></div>
</div>

<script>
(function(){
  document.addEventListener('touchmove', e=>e.preventDefault(), {passive:false});

  var app = document.getElementById('app');
  var starter = document.getElementById('starter');
  var startbtn = document.getElementById('startbtn');
  var controls=document.getElementById('controls');

  function makeCanvas(){
    var cv=document.createElement('canvas');
    cv.id='cv'; cv.style.position='fixed'; cv.style.inset='0'; cv.style.width='100vw'; cv.style.height='100svh'; cv.style.background='var(--bg)';
    cv.style.backgroundImage='radial-gradient(ellipse at 20% 10%, #ffffff, transparent 60%), radial-gradient(ellipse at 80% 90%, #f0f4ff, transparent 60%)';
    app.appendChild(cv);
    return cv;
  }

  // ===== Audio =====
  var actx=null, analyser=null, thFilter=null, thAmp=null, oscA=null, oscB=null, lfoTrem=null, lfoTremGain=null, lfoVib=null, lfoVibGain=null, envGain=null;
  var audList=[], audIdx=0, audio=new Audio(); audio.preload='auto', audio.crossOrigin='anonymous';
  audio.loop = true; 

  var bgmBus=null;
  var cv=null, ctx=null;
  var countUI=document.getElementById('count'), thickUI=document.getElementById('thick'), glowUI=document.getElementById('glow');
  var tvolUI=document.getElementById('tvol'), bgmUI=document.getElementById('bgm'), beatAmt=document.getElementById('beatAmt');
  var presetSel=document.getElementById('preset');
  var dirInput=document.getElementById('audDir');

  try{ if('webkitdirectory' in dirInput){ dirInput.setAttribute('webkitdirectory',''); dirInput.setAttribute('directory',''); } }catch(_){}

  var activePointers=new Map(); var holdTimer=null; var taps=0, tapTimer=null;
  function togglePanel(){ controls.classList.toggle('hidden'); }
  function clearPointers(){ activePointers.clear(); if(holdTimer){clearTimeout(holdTimer); holdTimer=null;} }
  function attachPanelGestures(target){
    target.addEventListener('pointerdown',e=>{activePointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); if(activePointers.size>=2&&!holdTimer){ holdTimer=setTimeout(togglePanel,1100);}},{passive:false});
    target.addEventListener('pointermove',e=>{ var p=activePointers.get(e.pointerId); if(!p) return; if(Math.abs(e.clientX-p.x)>20||Math.abs(e.clientY-p.y)>20) clearPointers(); },{passive:false});
    target.addEventListener('pointerup',()=>clearPointers(),{passive:false});
    target.addEventListener('pointercancel',()=>clearPointers(),{passive:false});
    target.addEventListener('pointerdown', ()=>{ taps++; if(taps===1){ tapTimer=setTimeout(()=>taps=0,1200);} if(taps>=3){ clearTimeout(tapTimer); taps=0; togglePanel(); } });
  }

  function ensureAudio(){
    if(actx) return;
    var AC=window.AudioContext||window.webkitAudioContext; actx=new AC();
    bgmBus=actx.createGain(); bgmBus.gain.value=parseFloat(bgmUI.value);
    analyser=actx.createAnalyser(); analyser.fftSize=256;

    envGain=actx.createGain(); envGain.gain.value=0.0;
    thAmp=actx.createGain(); thAmp.gain.value=parseFloat(tvolUI.value);
    thFilter=actx.createBiquadFilter(); thFilter.type='lowpass'; thFilter.frequency.value=1700; thFilter.Q.value=0.7;

    oscA=actx.createOscillator(); oscA.type='sine';
    oscB=actx.createOscillator(); oscB.type='sine'; oscB.detune.value=+6;

    lfoTrem=actx.createOscillator(); lfoTrem.type='sine'; lfoTrem.frequency.value=0.9;
    lfoTremGain=actx.createGain(); lfoTremGain.gain.value=0.08;

    lfoVib=actx.createOscillator(); lfoVib.type='sine'; lfoVib.frequency.value=5.5;
    lfoVibGain=actx.createGain(); lfoVibGain.gain.value=7.0;

    oscA.connect(thFilter); oscB.connect(thFilter);
    thFilter.connect(envGain).connect(thAmp).connect(analyser).connect(actx.destination);
    lfoVib.connect(lfoVibGain); lfoVibGain.connect(oscA.detune); lfoVibGain.connect(oscB.detune);
    lfoTrem.connect(lfoTremGain).connect(envGain.gain);

    var src=actx.createMediaElementSource(audio);
    src.connect(bgmBus);
    bgmBus.connect(analyser).connect(actx.destination);

    oscA.start(); oscB.start(); lfoTrem.start(); lfoVib.start();

    function up(){ if(bgmBus&&actx) bgmBus.gain.setTargetAtTime(parseFloat(bgmUI.value),actx.currentTime,0.05); }
    bgmUI.addEventListener('input', up);
    tvolUI.addEventListener('input', function(){ thAmp && thAmp.gain.setTargetAtTime(parseFloat(tvolUI.value), actx.currentTime, 0.05); });

    audio.addEventListener('ended', function(){
      if(presetSel.value!=='none') return;
      if(!audList.length) return;
      audIdx = (audIdx + 1) % audList.length;
      playIndex(audIdx);
    });
  }

  // --- Start & Random Logic ---
  var hasStarted = false;
  function startAll(forcedPreset){
    ensureAudio();
    try{ if(actx && actx.state!=='running') actx.resume(); }catch(_){}
    if(!cv){ cv=makeCanvas(); ctx=cv.getContext('2d',{alpha:false}); setupCanvas(); attachPanelGestures(cv); }
    if(starter && starter.parentNode){ starter.parentNode.removeChild(starter); }
    
    if(!hasStarted || forcedPreset){
      var mode = forcedPreset;
      if(!mode){
        var keys = ['dog','bear','elephant'];
        mode = keys[Math.floor(Math.random()*keys.length)];
      }
      presetSel.value = mode;
      startPreset(mode);
      if(typeof reset==='function'){ reset(); }
      hasStarted = true;
    }
  }

  startbtn.addEventListener('click', function(e){ e.stopPropagation(); startAll(null); });
  document.addEventListener('pointerdown', function one(){ 
    if(starter && starter.parentNode) { startAll(null); }
    document.removeEventListener('pointerdown', one, {capture:false}); 
  }, {capture:false, once:true});

  // ====== Canvas & Interaction ======
  var t=0, visScale=1, shapes=[];
  var COLORS=["#60a5fa","#f472b6","#facc15","#a78bfa","#34d399"];
  var ALL_TYPES=["dog","bear","elephant"];
  window.pitchHz=440;

  function setupCanvas(){
    var dprCap=1.5;
    function fitNow(){
      var dpr=Math.min(window.devicePixelRatio||1,dprCap);
      var vw=(window.visualViewport&&visualViewport.width?visualViewport.width:innerWidth);
      var vh=(window.visualViewport&&visualViewport.height?visualViewport.height:innerHeight);
      var w=Math.floor(vw*dpr), h=Math.floor(vh*dpr);
      if(w>0 && h>0){ cv.width=Math.max(360,w); cv.height=Math.max(360,h); return true; }
      return false;
    }
    function fitEnsure(){ if(!fitNow()){ var id=setInterval(function(){ if(fitNow()){ clearInterval(id); if(shapes.length===0) reset(); } }, 50); } else { if(shapes.length===0) reset(); } }
    fitEnsure();
    addEventListener('resize',fitEnsure,{passive:true});
    addEventListener('orientationchange',fitEnsure,{passive:true});
    if(window.visualViewport){ visualViewport.addEventListener('resize',fitEnsure,{passive:true}); }

    var pressStart=0, dragging=false, thereminOn=false, holdId=null;
    var lastPos={x:null,y:null};
    var chime=new Audio("./Chime.mp3"); chime.volume=0.3;

    function getCanvasPos(e){ var r=cv.getBoundingClientRect(); var x=(e.clientX-r.left)/r.width*cv.width; var y=(e.clientY-r.top)/r.height*cv.height; if(isFinite(x)&&isFinite(y)) return {x:x,y:y}; return null; }
    function updateLastPos(e){ var p=getCanvasPos(e); if(p) lastPos=p; }
    function startTheremin(){ thereminOn=true; var t=actx.currentTime; envGain.gain.cancelScheduledValues(t); envGain.gain.setTargetAtTime(1.0,t,0.02); }
    function stopTheremin(){ thereminOn=false; var t=actx.currentTime; envGain.gain.cancelScheduledValues(t); envGain.gain.setTargetAtTime(0.0,t,0.10); if(holdId){clearTimeout(holdId); holdId=null;} }

    cv.addEventListener('pointerdown', function(e){
      pressStart=Date.now(); dragging=true; updateLastPos(e);
      if(holdId) clearTimeout(holdId);
      holdId = setTimeout(function(){ startTheremin(); }, 220);
    });

    cv.addEventListener('pointermove', function(e){
      if(!dragging) return;
      updateLastPos(e);
      if(thereminOn){ onThereminDrag(e); }
    });

    window.addEventListener('pointerup', function(e){
      if(!dragging) return; dragging=false;
      if(holdId){ clearTimeout(holdId); holdId=null; }
      if(thereminOn){ stopTheremin(); }
      else{ doPluck(); try{ chime.currentTime=0; chime.play(); }catch(_){} doBurst(e); }
    });
    cv.addEventListener('pointercancel', function(){ dragging=false; if(holdId){clearTimeout(holdId); holdId=null;} stopTheremin(); });

    function onThereminDrag(e){ var p=getCanvasPos(e); if(!p) return; var beta=(p.y/cv.height - 0.5)*360; setPitchFromBeta(beta); }

    function reset(){ 
      shapes.length=0; 
      var n=Math.max(5,(countUI.value|0)); 
      var currentMode = presetSel.value;
      var typeCandidates = ALL_TYPES;
      if(currentMode !== 'none' && ALL_TYPES.includes(currentMode)){ typeCandidates = [currentMode]; }
      for(var i=0;i<n;i++){ 
        var type=typeCandidates[i%typeCandidates.length];
        var r=70*(0.6+Math.random()*0.6), x=Math.random()*cv.width, y=Math.random()*cv.height, rot=Math.random()*Math.PI*2, vx=(Math.random()-0.5)*0.5, vy=(Math.random()-0.5)*0.5, color=COLORS[i%COLORS.length]; 
        shapes.push({type:type,x:x,y:y,r:r,rot:rot,vx:vx,vy:vy,pulse:0,color:color,flash:0}); 
      } 
    }
    document.getElementById('count').addEventListener('input', reset); 
    presetSel.addEventListener('change', reset);

    function doBurst(e){ var p=getCanvasPos(e) || lastPos; if(!p) return; var px=p.x, py=p.y; for(var i=0;i<shapes.length;i++){ var s=shapes[i]; var ang=Math.atan2(s.y-py, s.x-px); var f=4.5 + Math.random()*3.0; s.vx += Math.cos(ang)*f; s.vy += Math.sin(ang)*f; s.pulse = Math.min(1.5, s.pulse+1.2); s.flash = 1.0; } }

    function drawShape(type,r){ 
      ctx.beginPath();
      if(type==="dog"){
        var w = r*0.85; ctx.ellipse(0, 0, w, r*0.7, 0, 0, Math.PI*2); 
        ctx.moveTo(-w*0.7, -r*0.2); ctx.ellipse(-w*0.9, r*0.2, r*0.3, r*0.6, 0.3, 0, Math.PI*2); 
        ctx.moveTo(w*0.7, -r*0.2); ctx.ellipse(w*0.9, r*0.2, r*0.3, r*0.6, -0.3, 0, Math.PI*2); 
      }
      else if(type==="bear"){
        ctx.arc(0, 0, r*0.8, 0, Math.PI*2); 
        ctx.moveTo(-r*0.4, -r*0.6); ctx.arc(-r*0.6, -r*0.65, r*0.3, 0, Math.PI*2); 
        ctx.moveTo(r*0.4, -r*0.6); ctx.arc(r*0.6, -r*0.65, r*0.3, 0, Math.PI*2); 
      }
      else if(type==="elephant"){
        ctx.arc(0, -r*0.1, r*0.6, 0, Math.PI*2); 
        ctx.moveTo(-r*0.4, -r*0.1); ctx.ellipse(-r*0.75, -r*0.1, r*0.4, r*0.6, 0, 0, Math.PI*2); 
        ctx.moveTo(r*0.4, -r*0.1); ctx.ellipse(r*0.75, -r*0.1, r*0.4, r*0.6, 0, 0, Math.PI*2); 
        ctx.moveTo(0, r*0.2); ctx.bezierCurveTo(0, r*0.8, r*0.4, r*1.0, r*0.5, r*0.6); 
      }
      else { ctx.rect(-r/2, -r/2, r, r); }
      ctx.stroke();
    }

    function draw(){
      var w=cv.width,h=cv.height;
      if(!ctx) return;
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || '#ffffff';
      ctx.fillRect(0,0,w,h);
      var lineBase=parseFloat(thickUI.value);
      var glow=parseFloat(glowUI.value);
      
      var beatVal=0;
      if(analyser){
        var dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        var sum=0; for(var k=0; k<10; k++){ sum+=dataArray[k]; }
        beatVal = sum/10; 
      }
      var bRate = parseFloat(beatAmt.value);
      var beatScale = 1.0 + (beatVal/255.0)*bRate; 
      var pmin=120, pmax=900;
      var pnorm=Math.min(1, Math.max(0, (window.pitchHz - pmin) / Math.max(1,(pmax-pmin))  ));
      var targetScale = (0.5 + 1.1*pnorm);
      visScale += (targetScale - visScale) * 0.15;
      var finalScale = visScale * beatScale;

      for(var i=0;i<shapes.length;i++){ var s=shapes[i];
        s.x+=s.vx; s.y+=s.vy; s.rot+=0.008;
        if(s.x<s.r){s.x=s.r; s.vx=Math.abs(s.vx);} if(s.x>w-s.r){s.x=w-s.r; s.vx=-Math.abs(s.vx);}
        if(s.y<s.r){s.y=s.r; s.vy=Math.abs(s.vy);} if(s.y>h-s.r){s.y=h-s.r; s.vy=-Math.abs(s.vy);}
        s.vx*=0.992; s.vy*=0.992;
        var base=1+0.07*Math.sin(t*0.03+s.x*0.003)+s.pulse*0.25;
        var rr=s.r*base*finalScale; s.pulse*=0.92;
        ctx.save(); ctx.translate(s.x,s.y); ctx.rotate(s.rot);
        ctx.lineJoin="round"; ctx.lineCap="round";
        ctx.shadowColor=s.color; ctx.shadowBlur=glow*2.2; ctx.strokeStyle=s.color; ctx.lineWidth=lineBase*2.6; drawShape(s.type,rr);
        ctx.shadowBlur=glow*0.8; ctx.strokeStyle=s.color; ctx.lineWidth=lineBase*1.6; drawShape(s.type,rr);
        ctx.shadowBlur=0; ctx.strokeStyle='#ffffff'; ctx.lineWidth=Math.max(1,lineBase*0.7); drawShape(s.type,rr);
        ctx.restore();
      }
      t++; requestAnimationFrame(draw);
    }
    requestAnimationFrame(draw);
  }

  function doPluck(){ if(!actx) return; var now=actx.currentTime; var o=actx.createOscillator(); o.type='triangle'; var g=actx.createGain(); g.gain.value=0.0; var lpf=actx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=2400; o.connect(lpf).connect(g).connect(actx.destination); var f=window.pitchHz||440; o.frequency.value=f; g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(0.9, now+0.01); g.gain.exponentialRampToValueAtTime(0.0001, now+0.28); o.start(now); o.stop(now+0.4); }
  function setPitchFromBeta(beta){ var pmin=120, pmax=900; var n=Math.min(1,Math.max(0,(beta+180)/360)); var curve=Math.sin(n*Math.PI); window.pitchHz = pmin + curve*(pmax-pmin); if(actx&&oscA&&oscB){ var t=actx.currentTime; oscA.frequency.setTargetAtTime(window.pitchHz,t,0.02); oscB.frequency.setTargetAtTime(window.pitchHz,t,0.02); } if(actx&&thFilter){ thFilter.frequency.setTargetAtTime(1400 + curve*1200, actx.currentTime, 0.06); } }

  // === Synth Melody & MP3 Hybrid ===
  var seqTimer=null, seqPos=0, seqData=null, seqTempo=100;
  function stopPreset(){ if(seqTimer){ clearTimeout(seqTimer); seqTimer=null; } seqPos=0; }
  
  // v3.1: Play Note with Duration
  function playNote(n, dur){
      var t=actx.currentTime; var o=actx.createOscillator(); o.type='triangle'; 
      var g=actx.createGain(); g.gain.value=0.0; var f=440*Math.pow(2,(n-69)/12); 
      var lpf=actx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=2200; 
      o.frequency.value=f; o.connect(lpf).connect(g).connect(bgmBus); 
      g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.8,t+0.02); 
      g.gain.exponentialRampToValueAtTime(0.001, t+dur*0.9); 
      o.start(t); o.stop(t+dur);
  }

  function startPreset(kind){ 
    ensureAudio(); stopPreset();
    var srcMap = { 'dog':'./dog.mp3', 'bear':'./bear.mp3', 'elephant':'./elephant.mp3' };
    var mp3Src = srcMap[kind];
    
    // MP3å„ªå…ˆå†ç”Ÿ
    audio.src = mp3Src;
    audio.loop = true;
    var playPromise = audio.play();
    
    if(playPromise !== undefined){
      playPromise.then(_ => { /*OK*/ }).catch(error => {
        console.log("MP3 not found, playing synth.");
        startSynthSeq(kind);
      });
    }
  }

  function startSynthSeq(kind){
    // ãƒªã‚ºãƒ å¯¾å¿œãƒ¡ãƒ­ãƒ‡ã‚£ (n:NoteNumber, d:Beats)
    if(kind==='dog'){ 
      seqTempo=120;
      // ã¾ã„ã”ã®(1) ã¾ã„ã”ã®(1) ã“ã­ã“ã¡ã‚ƒã‚“(1)
      seqData=[
        {n:60,d:0.5},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5}, {n:67,d:0.5},{n:67,d:0.5},{n:67,d:1.0}, // Mai-go-no Mai-go-no
        {n:null,d:0.5},
        {n:67,d:0.5},{n:69,d:0.5},{n:71,d:0.5},{n:72,d:0.5}, {n:71,d:0.5},{n:69,d:0.5},{n:67,d:1.0}, // Ko-ne-ko-chan
        {n:null,d:0.5},
        {n:65,d:0.5},{n:65,d:0.5},{n:65,d:0.5},{n:64,d:0.5}, {n:64,d:0.5},{n:64,d:0.5},{n:62,d:1.0}, // A-na-ta-no O-u-chi-wa
        {n:null,d:0.5},
        {n:62,d:0.5},{n:62,d:0.5},{n:64,d:0.5},{n:62,d:0.5}, {n:60,d:2.0}, // Do-ko-de-su-ka
        {n:null,d:1.0}
      ];
    }
    else if(kind==='bear'){ 
      seqTempo=110; 
      seqData=[
        {n:67,d:1.0},{n:67,d:1.0},{n:64,d:1.0},{n:65,d:1.0}, {n:67,d:1.0},{n:64,d:1.0},{n:60,d:2.0}, // Aruhi morino
        {n:null,d:0.5},
        {n:67,d:1.0},{n:67,d:1.0},{n:64,d:1.0},{n:65,d:1.0}, {n:67,d:1.0},{n:64,d:1.0},{n:60,d:2.0}, // Naka kuma
        {n:null,d:0.5},
        {n:60,d:0.5},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5}, {n:67,d:1.0},{n:67,d:1.0},{n:69,d:1.0},{n:67,d:1.0}, // Hanasaku mori
        {n:65,d:1.0},{n:65,d:1.0},{n:64,d:1.0},{n:62,d:1.0}, {n:60,d:2.0}, {n:null,d:1.0}
      ]; 
    }
    else if(kind==='elephant'){ 
      seqTempo=100; // 3/4 time feel? 
      // Zou(2) San(1) Zou(2) San(1)
      seqData=[
        {n:67,d:2.0},{n:64,d:1.0}, {n:67,d:2.0},{n:64,d:1.0}, // Zou-san Zou-san
        {n:67,d:1.0},{n:69,d:1.0},{n:67,d:1.0}, {n:64,d:2.0},{n:62,d:1.0}, // O-ha-na-ga Naga-i-no-ne
        {n:null,d:1.0},
        {n:60,d:1.0},{n:62,d:1.0},{n:64,d:1.0}, {n:65,d:3.0}, // So-u-yo
        {n:67,d:1.0},{n:67,d:1.0},{n:67,d:1.0}, // Ka-a-san-mo
        {n:67,d:1.0},{n:65,d:1.0},{n:64,d:1.0}, {n:62,d:2.0},{n:60,d:1.0}, // Na-ga-i-no-yo
        {n:null,d:2.0}
      ]; 
    }
    
    if(seqData){
        (function tick(){
          if(presetSel.value !== kind) return;
          var item = seqData[seqPos % seqData.length];
          var beatSec = 60/seqTempo;
          var dur = item.d * beatSec;
          
          if(item.n!=null){ playNote(item.n, dur); }
          seqPos++; 
          seqTimer = setTimeout(tick, dur*1000);
        })();
    }
  }

  presetSel.addEventListener('change', function(){ 
      stopPreset(); audio.pause();
      if(presetSel.value==='none'){ reset(); return; } 
      startAll(presetSel.value); 
  });

  function naturalSort(a,b){ return a.name.localeCompare(b.name,'ja',{numeric:true}); }
  dirInput.addEventListener('change', function(e){
    startAll('none');
    audList = Array.prototype.slice.call(e.target.files).filter(function(f){return f.type.indexOf('audio/')===0;}).sort(naturalSort);
    audIdx=0; if(audList.length){ presetSel.value='none'; playIndex(audIdx); }
  });
  function playIndex(i){
    if(!audList.length) return;
    presetSel.value='none'; 
    audio.src=URL.createObjectURL(audList[i]);
    ensureAudio();
    try{
      if(actx && actx.state!=='running') actx.resume();
      audio.loop = false; audio.play();
    }catch(_){}
  }
  document.getElementById('next').addEventListener('click',function(){ if(presetSel.value!=='none'){ return; } if(!audList.length)return; audIdx=(audIdx+1)%audList.length; playIndex(audIdx); });
  document.getElementById('prev').addEventListener('click',function(){ if(presetSel.value!=='none'){ return; } if(!audList.length)return; audIdx=(audIdx-1+audList.length)%audList.length; playIndex(audIdx); });
  document.getElementById('play').addEventListener('click',function(){ 
      startAll(); 
      if(actx && actx.state!=='running') try{actx.resume();}catch(_ ){} 
      if(audio.paused){ try{audio.play();}catch(_ ){} } else { audio.pause(); } 
  });

})();</script>

<script>
// autostart v3.1.8: skip starter, visuals unchanged. audio will resume on gesture if needed.
window.addEventListener('load', ()=>{ try{ if(typeof startAll==='function') startAll(null); }catch(e){ console.warn(e); } }, {once:true});
</script>

<script>
if("serviceWorker" in navigator){ navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())); }
</script>
</body>
</html>