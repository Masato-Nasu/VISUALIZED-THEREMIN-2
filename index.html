<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>Baby Theremin ‚Äì Songs & Shapes</title>
<link rel="manifest" href="./manifest.json?v=3.3.5">
<meta name="theme-color" content="#ffffff">
<style>
  :root{ --bg:#fafbfe; --text:#10121a; --panel:#ffffffcc; --shadow:rgba(0,0,0,.12); }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Roboto,"Noto Sans JP",sans-serif;
    overscroll-behavior:none; position:fixed; width:100%;
  }
  #bg {
    position:fixed; inset:0; z-index:0;
    background:
      radial-gradient(circle at 25% 15%, rgba(255,255,255,0.95), rgba(255,255,255,0) 55%),
      radial-gradient(circle at 80% 85%, rgba(240,244,255,0.95), rgba(240,244,255,0) 65%),
      linear-gradient(180deg,#ffffff,#f0f4ff);
  }
  #stage {
    position:fixed; inset:0; width:100vw; height:100vh; z-index:1;
    touch-action:none;
  }
  @supports (height: 100svh) { #stage { height:100svh; } }

  .starter{position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:transparent; z-index:100;
  }
  .starter .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px; padding:22px 18px;
    box-shadow:0 10px 30px rgba(0,0,0,.08); text-align:center; color:#111; max-width:90vw
  }
  .starter .big{font-size:18px; margin-bottom:10px; font-weight:700;}
  .starter .startbtn{appearance:none;border:0;background:#10b981;color:#fff;border-radius:12px;
    padding:14px 22px;font-size:18px;cursor:pointer; width:100%; font-weight:700;
  }
  .small{font-size:12px;color:#6b7280;margin-top:10px; line-height:1.35}

  #songBar{
    position:fixed; left:10px; bottom:10px; z-index:60;
    display:flex; gap:8px; flex-wrap:wrap; max-width:80vw;
  }
  .songBtn{
    width:42px; height:42px; border-radius:999px;
    background:var(--panel);
    backdrop-filter:saturate(1.05) blur(8px);
    border:1px solid #e5e7eb;
    box-shadow:0 10px 22px var(--shadow);
    display:flex; align-items:center; justify-content:center;
    user-select:none; -webkit-user-select:none;
    touch-action:manipulation;
    font-size:20px;
  }
  .songBtn.active{ outline:2px solid #111827; outline-offset:2px; }
  .songBtn:focus-visible{ outline:3px solid #111827; outline-offset:2px; }

  #emojiFallback{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:min(38vw,180px);
    z-index:20; pointer-events:none;
    opacity:0; transition:opacity .2s ease;
    filter: drop-shadow(0 12px 22px rgba(0,0,0,.12));
  }
  #emojiFallback.show{ opacity:1; }
</style>
</head>
<body>
<div id="bg"></div>

<div id="starter" class="starter">
  <div class="card">
    <div class="big">Baby Theremin</div>
    <div>„Äå„ÅØ„Åò„ÇÅ„Çã„Äç„ÇíÊäº„Åô„Å®„ÄÅ<br>Êõ≤„Å®ÂΩ¢„Åå„É©„É≥„ÉÄ„É†„ÅßÂßã„Åæ„Çã„Çà</div>
    <div style="margin-top:12px;">
      <button id="startbtn" class="startbtn">„ÅØ„Åò„ÇÅ„Çã ‚ñ∂</button>
    </div>
    <div class="small">Áü≠„Çø„ÉÉ„ÉóÔºö„ÅØ„Åò„Åë„Çã Ôºè Èï∑Êäº„ÅóÔºö„ÉÜ„É´„Éü„É≥<br>Â∑¶‰∏ã„Ç¢„Ç§„Ç≥„É≥ÔºöÊõ≤ÂàáÊõø„ÄÄv3.3.5</div>
  </div>
</div>

<div id="emojiFallback" aria-hidden="true">‚òÜ</div>
<svg id="stage" viewBox="0 0 1000 1000" preserveAspectRatio="none" aria-hidden="true">
  <defs>
    <filter id="glow" x="-60%" y="-60%" width="220%" height="220%">
      <feGaussianBlur stdDeviation="5" result="blur"/>
      <feMerge>
        <feMergeNode in="blur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs></svg>

<div id="songBar" aria-label="Êõ≤„Çí„Åà„Çâ„Å∂">
  <button class="songBtn" data-song="star" aria-label="„Åç„Çâ„Åç„ÇâÊòü">‚òÜ</button>
  <button class="songBtn" data-song="sheep" aria-label="„É°„É™„Éº„Åï„Çì„ÅÆÁæä">üêë</button>
  <button class="songBtn" data-song="bear" aria-label="Ê£Æ„ÅÆ„Åè„Åæ„Åï„Çì">üêª</button>
  <button class="songBtn" data-song="butterfly" aria-label="„Å°„Çá„ÅÜ„Å°„Çá„ÅÜ">ü¶ã</button>
  <button class="songBtn" data-song="bee" aria-label="„Å∂„Çì„Å∂„Çì„Å∂„Çì">üêù</button>
  <button class="songBtn" data-song="frog" aria-label="„Åã„Åà„Çã„ÅÆÂêàÂî±">üê∏</button>
</div>

<script>
(function(){
  const starter = document.getElementById('starter');
  const startbtn = document.getElementById('startbtn');
  const emojiFallback = document.getElementById('emojiFallback');
  const stage = document.getElementById('stage');
  const songButtons = Array.from(document.querySelectorAll('.songBtn'));

  // ===== Stage sizing =====
  let W=1000, H=1000;
  function fitStage(){
    const vw = (window.visualViewport && visualViewport.width) ? visualViewport.width : innerWidth;
    const vh = (window.visualViewport && visualViewport.height) ? visualViewport.height : innerHeight;
    W = 1000;
    H = 1000 * (vh/Math.max(1,vw));
    stage.setAttribute('viewBox', `0 0 ${W} ${H}`);
  }
  fitStage();
  addEventListener('resize', fitStage, {passive:true});
  addEventListener('orientationchange', fitStage, {passive:true});
  if(window.visualViewport) visualViewport.addEventListener('resize', fitStage, {passive:true});

  function ptFromEvent(e){
    const r = stage.getBoundingClientRect();
    const x = (e.clientX - r.left) / r.width * W;
    const y = (e.clientY - r.top) / r.height * H;
    if(Number.isFinite(x) && Number.isFinite(y)) return {x,y};
    return null;
  }

  // ===== Audio =====
  const AC = window.AudioContext || window.webkitAudioContext;
  let actx=null, analyser=null, master=null, melodyBus=null, thBus=null;
  let thFilter=null, envGain=null, oscA=null, oscB=null, lfoTrem=null, lfoTremGain=null, lfoVib=null, lfoVibGain=null;
  let seqTimer=null, seqPos=0, currentSong=null;

  const chime = new Audio('./Chime.mp3');
  chime.volume = 0.30;

  function ensureAudio(){
    if(actx) return;
    actx = new AC();

    analyser = actx.createAnalyser();
    analyser.fftSize = 256;

    master = actx.createGain(); master.gain.value = 0.90;
    melodyBus = actx.createGain(); melodyBus.gain.value = 0.60;
    thBus = actx.createGain(); thBus.gain.value = 0.28;

    melodyBus.connect(analyser);
    thBus.connect(analyser);
    analyser.connect(master);
    master.connect(actx.destination);

    // --- Music-box-ish ambience (subtle delay) ---
    const mbDelay = actx.createDelay(0.45);
    mbDelay.delayTime.value = 0.18;
    const mbWet = actx.createGain();
    mbWet.gain.value = 0.34;
    const mbFb = actx.createGain();
    mbFb.gain.value = 0.18;
    const mbFbLP = actx.createBiquadFilter();
    mbFbLP.type = 'lowpass';
    mbFbLP.frequency.value = 1800;

    mbDelay.connect(mbFbLP);
    mbFbLP.connect(mbFb);
    mbFb.connect(mbDelay);

    melodyBus.connect(mbDelay);
    mbDelay.connect(mbWet);
    mbWet.connect(analyser);

    const noiseLen = Math.floor(actx.sampleRate * 0.03);
    window.__mbNoise = actx.createBuffer(1, noiseLen, actx.sampleRate);
    const ch = window.__mbNoise.getChannelData(0);
    for(let i=0;i<noiseLen;i++){
      const env = Math.pow(1 - i/noiseLen, 2.4);
      ch[i] = (Math.random()*2-1) * env * 0.35;
    }

    // Theremin
    envGain = actx.createGain(); envGain.gain.value = 0.0;

    thFilter = actx.createBiquadFilter();
    thFilter.type = 'lowpass'; thFilter.frequency.value = 1200; thFilter.Q.value = 0.45;

    const thSoftLP = actx.createBiquadFilter();
    thSoftLP.type = 'lowpass';
    thSoftLP.frequency.value = 1400;
    thSoftLP.Q.value = 0.35;

    oscA = actx.createOscillator(); oscA.type = 'sine';
    oscB = actx.createOscillator(); oscB.type = 'sine'; oscB.detune.value = +6;

    lfoTrem = actx.createOscillator(); lfoTrem.type = 'sine'; lfoTrem.frequency.value = 0.9;
    lfoTremGain = actx.createGain(); lfoTremGain.gain.value = 0.05;

    lfoVib = actx.createOscillator(); lfoVib.type = 'sine'; lfoVib.frequency.value = 5.5;
    lfoVibGain = actx.createGain(); lfoVibGain.gain.value = 7.0;

    oscA.connect(thFilter);
    oscB.connect(thFilter);
    thFilter.connect(thSoftLP);
    thSoftLP.connect(envGain);
    envGain.connect(thBus);

    lfoVib.connect(lfoVibGain);
    lfoVibGain.connect(oscA.detune);
    lfoVibGain.connect(oscB.detune);

    lfoTrem.connect(lfoTremGain);
    lfoTremGain.connect(envGain.gain);

    oscA.start(); oscB.start(); lfoTrem.start(); lfoVib.start();
  }

  function resumeAudio(){
    ensureAudio();
    try{ if(actx && actx.state !== 'running') actx.resume(); }catch(_ ){}
  }

  function n2f(n){ return 440 * Math.pow(2, (n-69)/12); }

  function playNote(n, durSec){
    if(!actx) return;
    const t0 = actx.currentTime;

    const o1 = actx.createOscillator();
    const o2 = actx.createOscillator();
    const o3 = actx.createOscillator();
    o1.type = 'sine';
    o2.type = 'sine';
    o3.type = 'triangle';

    o1.frequency.value = n2f(n);
    o2.frequency.value = n2f(n-12);
    o3.frequency.value = n2f(n);
    o1.detune.value = -3;
    o3.detune.value = +3;

    const mix = actx.createGain();
    mix.gain.value = 1.0;

    const g2 = actx.createGain(); g2.gain.value = 0.20;
    const g3 = actx.createGain(); g3.gain.value = 0.18;

    o1.connect(mix);
    o2.connect(g2).connect(mix);
    o3.connect(g3).connect(mix);

    const g = actx.createGain();
    g.gain.setValueAtTime(0.0, t0);
    g.gain.linearRampToValueAtTime(0.95, t0+0.008);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+Math.max(0.08, durSec*0.92));

    const hp = actx.createBiquadFilter();
    hp.type = 'highpass';
    hp.frequency.value = 140;

    const lp = actx.createBiquadFilter();
    lp.type = 'lowpass';
    lp.frequency.value = 3200;

    mix.connect(hp).connect(lp).connect(g).connect(melodyBus);

    try{
      if(window.__mbNoise){
        const ns = actx.createBufferSource();
        ns.buffer = window.__mbNoise;
        const ng = actx.createGain();
        ng.gain.setValueAtTime(0.0, t0);
        ng.gain.linearRampToValueAtTime(0.35, t0+0.003);
        ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.03);

        const nhp = actx.createBiquadFilter();
        nhp.type = 'highpass';
        nhp.frequency.value = 900;

        ns.connect(nhp).connect(ng).connect(melodyBus);
        ns.start(t0);
        ns.stop(t0+0.05);
      }
    }catch(_e){}

    o1.start(t0); o2.start(t0); o3.start(t0);
    const stopT = t0 + durSec + 0.04;
    o1.stop(stopT); o2.stop(stopT); o3.stop(stopT);
  }

  // ===== Songs =====
  const SONGS = {
    star: { label:'„Åç„Çâ„Åç„ÇâÊòü', icon:'‚òÜ', tempo:112, type:'star', color:'#facc15',
      seq:[{n:60,d:1},{n:60,d:1},{n:67,d:1},{n:67,d:1},{n:69,d:1},{n:69,d:1},{n:67,d:2},
           {n:65,d:1},{n:65,d:1},{n:64,d:1},{n:64,d:1},{n:62,d:1},{n:62,d:1},{n:60,d:2},{n:null,d:1}] },
    sheep: { label:'„É°„É™„Éº„Åï„Çì„ÅÆÁæä', icon:'üêë', tempo:116, type:'sheep', color:'#60a5fa',
      seq:[{n:64,d:1},{n:62,d:1},{n:60,d:1},{n:62,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:2},
           {n:62,d:1},{n:62,d:1},{n:62,d:2},{n:64,d:1},{n:67,d:1},{n:67,d:2},
           {n:64,d:1},{n:62,d:1},{n:60,d:1},{n:62,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:2},{n:null,d:1}] },
    butterfly: { label:'„Å°„Çá„ÅÜ„Å°„Çá„ÅÜ', icon:'ü¶ã', tempo:120, type:'butterfly', color:'#a78bfa',
      seq:[{n:67,d:1},{n:64,d:1},{n:64,d:2},{n:65,d:1},{n:62,d:1},{n:62,d:2},
           {n:60,d:1},{n:62,d:1},{n:64,d:1},{n:65,d:1},{n:67,d:1},{n:67,d:1},{n:67,d:2},
           {n:67,d:1},{n:69,d:1},{n:69,d:2},{n:67,d:1},{n:65,d:1},{n:65,d:2},
           {n:64,d:1},{n:62,d:1},{n:62,d:2},{n:60,d:2},{n:null,d:1}] },
    bee: { label:'„Å∂„Çì„Å∂„Çì„Å∂„Çì', icon:'üêù', tempo:110, type:'bee', color:'#34d399',
      seq:[{n:67,d:1},{n:65,d:1},{n:64,d:2},
           {n:62,d:1},{n:64,d:1},{n:65,d:1},{n:62,d:1},{n:60,d:2},
           {n:64,d:1},{n:65,d:1},{n:67,d:1},{n:64,d:1},
           {n:62,d:1},{n:64,d:1},{n:65,d:1},{n:62,d:1},
           {n:64,d:1},{n:65,d:1},{n:67,d:1},{n:64,d:1},
           {n:62,d:1},{n:64,d:1},{n:65,d:1},{n:62,d:1},
           {n:67,d:1},{n:65,d:1},{n:64,d:2},
           {n:62,d:1},{n:64,d:1},{n:65,d:1},{n:62,d:1},{n:60,d:2},{n:null,d:1}] },
    frog: { label:'„Åã„Åà„Çã„ÅÆÂêàÂî±', icon:'üê∏', tempo:118, type:'frog', color:'#34d399',
      seq:[{n:60,d:1},{n:62,d:1},{n:64,d:1},{n:65,d:1},{n:64,d:1},{n:62,d:1},{n:60,d:2},
           {n:64,d:1},{n:65,d:1},{n:67,d:1},{n:69,d:1},{n:67,d:1},{n:65,d:1},{n:64,d:2},
           {n:60,d:1},{n:60,d:1},{n:60,d:1},{n:60,d:1},
           {n:60,d:0.5},{n:60,d:0.5},{n:62,d:0.5},{n:62,d:0.5},{n:64,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:65,d:0.5},
           {n:64,d:1},{n:62,d:1},{n:60,d:2},{n:null,d:1}] },
    bear: { label:'Ê£Æ„ÅÆ„Åè„Åæ„Åï„Çì', icon:'üêª', tempo:104, type:'bear', color:'#f472b6',
      seq:[{n:67,d:1},{n:66,d:1},{n:67,d:1},{n:64,d:1},{n:64,d:1},{n:63,d:1},{n:64,d:1},{n:60,d:1},
           {n:64,d:1},{n:62,d:1},{n:60,d:1},{n:62,d:1},
           {n:67,d:1},{n:69,d:1},{n:67,d:1},{n:64,d:1},
           {n:67,d:1},{n:69,d:1},{n:71,d:1},{n:72,d:1},{n:67,d:1},{n:64,d:1},{n:60,d:1},{n:69,d:1},
           {n:69,d:1},{n:71,d:1},{n:69,d:1},{n:67,d:1},{n:65,d:1},{n:64,d:1},{n:62,d:1},{n:60,d:1},
           {n:null,d:1}] },
  };
  const SONG_KEYS = Object.keys(SONGS);

  function stopSong(){ if(seqTimer){ clearTimeout(seqTimer); seqTimer=null; } seqPos=0; }
  function setActiveButton(k){ songButtons.forEach(b=>b.classList.toggle('active', b.dataset.song===k)); }
  function updateEmoji(){ const ic = SONGS[currentSong]?.icon || '‚òÜ'; emojiFallback.textContent = ic; emojiFallback.classList.add('show'); }

  function startSong(k){
    resumeAudio();
    stopSong();
    currentSong = k;
    setActiveButton(k);
    updateEmoji();
    resetShapes();

    const song = SONGS[k];
    const beatSec = 60 / song.tempo;
    (function tick(){
      if(!currentSong) return;
      const item = song.seq[seqPos % song.seq.length];
      const dur = (item.d||1) * beatSec;
      if(item.n!=null) playNote(item.n, dur*0.98);
      seqPos++;
      seqTimer = setTimeout(tick, Math.max(20, dur*1000));
    })();
  }
  function randomStart(){ startSong(SONG_KEYS[(Math.random()*SONG_KEYS.length)|0]); }

  // ===== SVG neon (animal-by-song) =====
  const SHAPE_COUNT = 20;
  const LINE_BASE = 8;
  const BEAT_AMT = 0.18;
  let shapes = [];
  let t=0;

  function el(name){ return document.createElementNS('http://www.w3.org/2000/svg', name); }

  function pathD(type){
    // normalized around origin in [-1,1]
    if(type==='star'){
      return 'M 0 -1 L 0.235 -0.324 L 0.951 -0.309 L 0.381 0.124 L 0.588 0.809 L 0 0.4 L -0.588 0.809 L -0.381 0.124 L -0.951 -0.309 L -0.235 -0.324 Z';
    }
    if(type==='sheep'){
      // fluffy body + head (simple, readable)
      return 'M -0.85 0.05 C -0.98 -0.22 -0.72 -0.55 -0.38 -0.45 C -0.30 -0.78 0.15 -0.82 0.25 -0.55 C 0.55 -0.78 0.98 -0.35 0.75 -0.08 C 0.98 0.08 0.86 0.55 0.52 0.45 C 0.35 0.78 -0.22 0.78 -0.26 0.52 C -0.62 0.68 -0.98 0.40 -0.85 0.05 Z ' +
             'M 0.72 0.10 m -0.26 0 a 0.26 0.26 0 1 0 0.52 0 a 0.26 0.26 0 1 0 -0.52 0 ' +
             'M 0.62 0.08 m -0.05 0 a 0.05 0.05 0 1 0 0.10 0 a 0.05 0.05 0 1 0 -0.10 0 ' +
             'M 0.82 0.08 m -0.05 0 a 0.05 0.05 0 1 0 0.10 0 a 0.05 0.05 0 1 0 -0.10 0';
    }
    if(type==='bear'){
      // bear face (head + ears + eyes + nose)
      return 'M 0 0 m -0.72 0 a 0.72 0.72 0 1 0 1.44 0 a 0.72 0.72 0 1 0 -1.44 0 ' +
             'M -0.48 -0.70 m -0.22 0 a 0.22 0.22 0 1 0 0.44 0 a 0.22 0.22 0 1 0 -0.44 0 ' +
             'M 0.48 -0.70 m -0.22 0 a 0.22 0.22 0 1 0 0.44 0 a 0.22 0.22 0 1 0 -0.44 0 ' +
             'M -0.22 -0.10 m -0.06 0 a 0.06 0.06 0 1 0 0.12 0 a 0.06 0.06 0 1 0 -0.12 0 ' +
             'M 0.22 -0.10 m -0.06 0 a 0.06 0.06 0 1 0 0.12 0 a 0.06 0.06 0 1 0 -0.12 0 ' +
             'M 0 0.10 m -0.10 0 a 0.10 0.08 0 1 0 0.20 0 a 0.10 0.08 0 1 0 -0.20 0 ' +
             'M -0.14 0.18 Q 0 0.30 0.14 0.18';
    }
    if(type==='butterfly'){
      // butterfly: body + two wings
      return 'M 0 -0.72 L 0 0.72 ' +
             'M 0 -0.18 C -0.95 -0.95 -1.10 0.35 -0.20 0.22 C -0.90 0.85 -0.18 1.00 0 0.45 ' +
             'M 0 -0.18 C 0.95 -0.95 1.10 0.35 0.20 0.22 C 0.90 0.85 0.18 1.00 0 0.45 ' +
             'M 0 -0.72 C -0.10 -0.92 -0.22 -1.00 -0.34 -1.05 ' +
             'M 0 -0.72 C 0.10 -0.92 0.22 -1.00 0.34 -1.05';
    }
    if(type==='bee'){
      // bee: body + stripes + wings + stinger
      return 'M -0.90 0 C -0.90 -0.50 -0.30 -0.78 0.28 -0.74 C 0.86 -0.70 0.95 -0.18 0.86 0.10 C 0.76 0.65 0.12 0.78 -0.30 0.62 C -0.82 0.42 -0.90 0.15 -0.90 0 Z ' +
             'M -0.28 -0.62 L -0.28 0.58 M 0 -0.72 L 0 0.70 M 0.28 -0.62 L 0.28 0.58 ' +
             'M -0.10 -0.58 C -0.60 -1.05 -1.05 -0.62 -0.62 -0.25 C -0.32 0.02 -0.02 -0.12 -0.10 -0.58 Z ' +
             'M 0.10 -0.58 C 0.60 -1.05 1.05 -0.62 0.62 -0.25 C 0.32 0.02 0.02 -0.12 0.10 -0.58 Z ' +
             'M 0.90 0 L 1.08 -0.10 L 1.08 0.10 Z';
    }
    if(type==='frog'){
      // frog face (round + eyes + smile)
      return 'M -0.85 0.15 C -0.85 -0.40 -0.55 -0.78 -0.10 -0.78 C 0.55 -0.78 0.85 -0.40 0.85 0.15 C 0.85 0.85 0.20 0.86 0 0.65 C -0.20 0.86 -0.85 0.85 -0.85 0.15 Z ' +
             'M -0.45 -0.48 m -0.16 0 a 0.16 0.16 0 1 0 0.32 0 a 0.16 0.16 0 1 0 -0.32 0 ' +
             'M 0.45 -0.48 m -0.16 0 a 0.16 0.16 0 1 0 0.32 0 a 0.16 0.16 0 1 0 -0.32 0 ' +
             'M -0.32 0.25 Q 0 0.45 0.32 0.25';
    }
    return 'M 0 -1 L 0.235 -0.324 L 0.951 -0.309 L 0.381 0.124 L 0.588 0.809 L 0 0.4 L -0.588 0.809 L -0.381 0.124 L -0.951 -0.309 L -0.235 -0.324 Z';
  }

  function makeNeonGroup(color, type){
    const g = el('g');
    const d = pathD(type);

    const p1 = el('path');
    p1.setAttribute('d', d);
    p1.setAttribute('fill', 'none');
    p1.setAttribute('stroke', color);
    p1.setAttribute('stroke-width', String(LINE_BASE*2.2));
    p1.setAttribute('stroke-linecap','round');
    p1.setAttribute('stroke-linejoin','round');
    p1.setAttribute('vector-effect','non-scaling-stroke');
    p1.setAttribute('opacity','0.14');
    // soft glow (stable): blur inside SVG filter
    p1.setAttribute('filter','url(#glow)');

    const p2 = el('path');
    p2.setAttribute('d', d);
    p2.setAttribute('fill', 'none');
    p2.setAttribute('stroke', color);
    p2.setAttribute('stroke-width', String(LINE_BASE*1.45));
    p2.setAttribute('stroke-linecap','round');
    p2.setAttribute('stroke-linejoin','round');
    p2.setAttribute('vector-effect','non-scaling-stroke');
    p2.setAttribute('opacity','0.80');

    const p3 = el('path');
    p3.setAttribute('d', d);
    p3.setAttribute('fill', 'none');
    p3.setAttribute('stroke', '#ffffff');
    p3.setAttribute('stroke-width', String(Math.max(1, LINE_BASE*0.60)));
    p3.setAttribute('stroke-linecap','round');
    p3.setAttribute('stroke-linejoin','round');
    p3.setAttribute('vector-effect','non-scaling-stroke');
    p3.setAttribute('opacity','0.95');

    g.appendChild(p1); g.appendChild(p2); g.appendChild(p3);
    return g;
  }

  function clearStageButDefs(){
    // keep <defs> as first child
    const kids = Array.from(stage.childNodes);
    for(const k of kids){
      if(k.nodeType===1 && k.nodeName.toLowerCase()==='defs') continue;
      stage.removeChild(k);
    }
  }

  function resetShapes(){
    shapes.length = 0;
    clearStageButDefs();

    const song = SONGS[currentSong] || SONGS.star;
    const type = song.type || 'star';
    const color = song.color || '#60a5fa';

    // fallback emoji updates already handled elsewhere
    for(let i=0;i<SHAPE_COUNT;i++){
      const r = 45*(0.75+Math.random()*1.05);
      const x = Math.random()*W;
      const y = Math.random()*H;
      const rot = Math.random()*Math.PI*2;
      const vx = (Math.random()-0.5)*0.55;
      const vy = (Math.random()-0.5)*0.55;

      const g = makeNeonGroup(color, type);
      stage.appendChild(g);
      shapes.push({type,color,x,y,r,rot,vx,vy,pulse:0,g});
    }
    // hide emoji once shapes are on screen
    emojiFallback.classList.remove('show');
  }

  function burstAt(px,py){
    for(const s of shapes){
      const ang = Math.atan2(s.y-py, s.x-px);
      const f = 4.5 + Math.random()*3.0;
      s.vx += Math.cos(ang)*f;
      s.vy += Math.sin(ang)*f;
      s.pulse = Math.min(1.5, s.pulse+1.2);
    }
  }

  function getBeatScale(){
    if(!analyser) return 1.0;
    const data = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);
    let sum = 0;
    for(let i=0;i<10;i++) sum += data[i] || 0;
    const beatVal = (sum/10) / 255;
    return 1.0 + beatVal * BEAT_AMT;
  }

  function drawLoop(){
    const beatScale = getBeatScale();
    for(const s of shapes){
      s.x += s.vx; s.y += s.vy; s.rot += 0.008;
      const rr = s.r;
      if(s.x<rr){ s.x=rr; s.vx=Math.abs(s.vx); }
      if(s.x>W-rr){ s.x=W-rr; s.vx=-Math.abs(s.vx); }
      if(s.y<rr){ s.y=rr; s.vy=Math.abs(s.vy); }
      if(s.y>H-rr){ s.y=H-rr; s.vy=-Math.abs(s.vy); }
      s.vx *= 0.992; s.vy *= 0.992;

      const base = 1 + 0.07*Math.sin(t*0.03 + s.x*0.003) + s.pulse*0.25;
      const size = s.r * base * beatScale;
      s.pulse *= 0.92;

      const tx = s.x, ty = s.y;
      const rotDeg = (s.rot * 180/Math.PI).toFixed(2);
      s.g.setAttribute('transform', `translate(${tx.toFixed(2)},${ty.toFixed(2)}) rotate(${rotDeg}) scale(${size.toFixed(3)})`);
    }
    t++;
    requestAnimationFrame(drawLoop);
  }

  // ===== Interaction =====
  let dragging=false, thereminOn=false, holdId=null, lastPos=null;
  window.pitchHz = 440;

  function setPitchFromY(y){
    const pmin=120, pmax=900;
    const n = Math.min(1, Math.max(0, y / H));
    const curve = Math.sin((1-n)*Math.PI);
    window.pitchHz = pmin + curve*(pmax-pmin);
    if(actx && oscA && oscB){
      const t0 = actx.currentTime;
      oscA.frequency.setTargetAtTime(window.pitchHz, t0, 0.02);
      oscB.frequency.setTargetAtTime(window.pitchHz, t0, 0.02);
    }
    if(actx && thFilter){
      const t0 = actx.currentTime;
      thFilter.frequency.setTargetAtTime(1100 + curve*900, t0, 0.06);
    }
  }

  function startTheremin(){
    if(!actx) return;
    thereminOn = true;
    const t0 = actx.currentTime;
    envGain.gain.cancelScheduledValues(t0);
    envGain.gain.setTargetAtTime(1.0, t0, 0.06);
  }
  function stopTheremin(){
    if(!actx) return;
    thereminOn = false;
    const t0 = actx.currentTime;
    envGain.gain.cancelScheduledValues(t0);
    envGain.gain.setTargetAtTime(0.0, t0, 0.16);
  }

  function pluck(){
    if(!actx) return;
    const now = actx.currentTime;
    const o = actx.createOscillator();
    const g = actx.createGain();
    const lp = actx.createBiquadFilter();
    o.type = 'triangle';
    lp.type = 'lowpass'; lp.frequency.value = 2400;
    o.frequency.value = window.pitchHz || 440;
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.9, now+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.28);
    o.connect(lp).connect(g).connect(master);
    o.start(now);
    o.stop(now+0.4);
  }

  stage.addEventListener('pointerdown', (e)=>{
    resumeAudio();
    dragging=true;
    lastPos = ptFromEvent(e);
    if(holdId) clearTimeout(holdId);
    holdId = setTimeout(()=>{ startTheremin(); }, 220);
  }, {passive:false});

  stage.addEventListener('pointermove', (e)=>{
    if(!dragging) return;
    const p = ptFromEvent(e);
    if(p) lastPos = p;
    if(thereminOn && p) setPitchFromY(p.y);
  }, {passive:false});

  window.addEventListener('pointerup', (e)=>{
    if(!dragging) return;
    dragging=false;
    if(holdId){ clearTimeout(holdId); holdId=null; }
    if(thereminOn){ stopTheremin(); }
    else {
      pluck();
      try{ chime.currentTime=0; chime.play(); }catch(_ ){}
      const p = ptFromEvent(e) || lastPos;
      if(p) burstAt(p.x,p.y);
    }
  }, {passive:false});

  // ===== Start flow =====
  let started=false;
  function startApp(){
    if(started) return;
    started=true;
    if(starter && starter.parentNode) starter.parentNode.removeChild(starter);
    randomStart();
    resetShapes();
    requestAnimationFrame(drawLoop);
  }

  startbtn.addEventListener('click', (e)=>{ e.stopPropagation(); startApp(); });
  songButtons.forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      if(!started) startApp();
      startSong(btn.dataset.song);
      resetShapes();
    });
  });
})();
</script>
<script>
if("serviceWorker" in navigator){ navigator.serviceWorker.register("./sw.js?v=3.3.5"); }
</script>
</body>
</html>
