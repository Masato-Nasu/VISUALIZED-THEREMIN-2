<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>Baby Theremin ‚Äì Songs & Shapes</title>
<link rel="manifest" href="./manifest.json?v=3.2.3">
<meta name="theme-color" content="#ffffff">
<style>
  :root{ --bg:#fafbfe; --text:#10121a; --panel:#ffffffcc; --shadow:rgba(0,0,0,.12); }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Roboto,"Noto Sans JP",sans-serif;
    overscroll-behavior:none; position:fixed; width:100%;
  }
  canvas{ position:fixed; inset:0; width:100vw; height:100vh; }
  @supports (height: 100svh) { canvas{ height:100svh; } }

  .starter{position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#ffffff,#f0f4ff); z-index:100;
  }
  .starter .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px; padding:22px 18px;
    box-shadow:0 10px 30px rgba(0,0,0,.08); text-align:center; color:#111; max-width:90vw
  }
  .starter .big{font-size:18px; margin-bottom:10px; font-weight:700;}
  .starter .startbtn{appearance:none;border:0;background:#10b981;color:#fff;border-radius:12px;
    padding:14px 22px;font-size:18px;cursor:pointer; width:100%; font-weight:700;
  }
  .small{font-size:12px;color:#6b7280;margin-top:10px; line-height:1.35}

  #songBar{
    position:fixed; left:10px; bottom:10px; z-index:60;
    display:flex; gap:8px; flex-wrap:wrap; max-width:80vw;
  }
  .songBtn{
    width:42px; height:42px; border-radius:999px;
    background:var(--panel);
    backdrop-filter:saturate(1.05) blur(8px);
    border:1px solid #e5e7eb;
    box-shadow:0 10px 22px var(--shadow);
    display:flex; align-items:center; justify-content:center;
    user-select:none; -webkit-user-select:none;
    touch-action:manipulation;
    font-size:20px;
  }
  .songBtn.active{ outline:2px solid #111827; outline-offset:2px; }
  .songBtn:focus-visible{ outline:3px solid #111827; outline-offset:2px; }

  #emojiFallback{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:min(38vw,180px);
    z-index:20; pointer-events:none;
    opacity:0; transition:opacity .2s ease;
    filter: drop-shadow(0 12px 22px rgba(0,0,0,.12));
  }
  #emojiFallback.show{ opacity:1; }
</style>
</head>
<body>
<div id="starter" class="starter">
  <div class="card">
    <div class="big">Baby Theremin</div>
    <div>„Äå„ÅØ„Åò„ÇÅ„Çã„Äç„ÇíÊäº„Åô„Å®„ÄÅ<br>Êõ≤„Å®ÂΩ¢„Åå„É©„É≥„ÉÄ„É†„ÅßÂßã„Åæ„Çã„Çà</div>
    <div style="margin-top:12px;">
      <button id="startbtn" class="startbtn">„ÅØ„Åò„ÇÅ„Çã ‚ñ∂</button>
    </div>
    <div class="small">Áü≠„Çø„ÉÉ„ÉóÔºö„ÅØ„Åò„Åë„Çã Ôºè Èï∑Êäº„ÅóÔºö„ÉÜ„É´„Éü„É≥<br>Â∑¶‰∏ã„Ç¢„Ç§„Ç≥„É≥ÔºöÊõ≤ÂàáÊõø„ÄÄv3.2.3</div>
  </div>
</div>

<div id="emojiFallback" aria-hidden="true">‚òÜ</div>
<canvas id="cv"></canvas>

<div id="songBar" aria-label="Êõ≤„Çí„Åà„Çâ„Å∂">
  <button class="songBtn" data-song="star" aria-label="„Åç„Çâ„Åç„ÇâÊòü">‚òÜ</button>
  <button class="songBtn" data-song="sheep" aria-label="„É°„É™„Éº„Åï„Çì„ÅÆÁæä">üêë</button>
  <button class="songBtn" data-song="bear" aria-label="Ê£Æ„ÅÆ„Åè„Åæ„Åï„Çì">üêª</button>
  <button class="songBtn" data-song="butterfly" aria-label="„Å°„Çá„ÅÜ„Å°„Çá„ÅÜ">ü¶ã</button>
  <button class="songBtn" data-song="bee" aria-label="„Å∂„Çì„Å∂„Çì„Å∂„Çì">üêù</button>
  <button class="songBtn" data-song="frog" aria-label="„Åã„Åà„Çã„ÅÆÂêàÂî±">üê∏</button>
</div>

<script>
(function(){
  const starter = document.getElementById('starter');
  const startbtn = document.getElementById('startbtn');
  const emojiFallback = document.getElementById('emojiFallback');
  const cv = document.getElementById('cv');
  let ctx = cv.getContext('2d');
  const songButtons = Array.from(document.querySelectorAll('.songBtn'));

  // ===== Canvas setup =====
  const dprCap = 1.6;
  function fitCanvas(){
    const dpr = Math.min(window.devicePixelRatio||1, dprCap);
    const vw = (window.visualViewport && visualViewport.width) ? visualViewport.width : innerWidth;
    const vh = (window.visualViewport && visualViewport.height) ? visualViewport.height : innerHeight;
    const w = Math.floor(vw*dpr), h = Math.floor(vh*dpr);
    if(w>0 && h>0){ cv.width = Math.max(360, w); cv.height = Math.max(360, h); }
  }
  fitCanvas();
  addEventListener('resize', fitCanvas, {passive:true});
  addEventListener('orientationchange', fitCanvas, {passive:true});
  if(window.visualViewport) visualViewport.addEventListener('resize', fitCanvas, {passive:true});

  function paintBG(){
    ctx.fillStyle = '#fafbfe';
    ctx.fillRect(0,0,cv.width,cv.height);
    const g1 = ctx.createRadialGradient(cv.width*0.25, cv.height*0.15, 0, cv.width*0.25, cv.height*0.15, cv.width*0.55);
    g1.addColorStop(0,'rgba(255,255,255,0.95)');
    g1.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle = g1; ctx.fillRect(0,0,cv.width,cv.height);
    const g2 = ctx.createRadialGradient(cv.width*0.80, cv.height*0.85, 0, cv.width*0.80, cv.height*0.85, cv.width*0.65);
    g2.addColorStop(0,'rgba(240,244,255,0.95)');
    g2.addColorStop(1,'rgba(240,244,255,0)');
    ctx.fillStyle = g2; ctx.fillRect(0,0,cv.width,cv.height);
  }

  // ===== Audio =====
  const AC = window.AudioContext || window.webkitAudioContext;
  let actx=null, analyser=null, master=null, melodyBus=null, thBus=null;
  let thFilter=null, envGain=null, oscA=null, oscB=null, lfoTrem=null, lfoTremGain=null, lfoVib=null, lfoVibGain=null;
  let seqTimer=null, seqPos=0, currentSong=null;

  const chime = new Audio('./Chime.mp3');
  chime.volume = 0.30;

  function ensureAudio(){
    if(actx) return;
    actx = new AC();

    analyser = actx.createAnalyser();
    analyser.fftSize = 256;

    master = actx.createGain(); master.gain.value = 0.90;
    melodyBus = actx.createGain(); melodyBus.gain.value = 0.60;
    thBus = actx.createGain(); thBus.gain.value = 0.40;

    melodyBus.connect(analyser);
    thBus.connect(analyser);
    analyser.connect(master);
    master.connect(actx.destination);

    // Theremin
    envGain = actx.createGain(); envGain.gain.value = 0.0;
    thFilter = actx.createBiquadFilter();
    thFilter.type = 'lowpass'; thFilter.frequency.value = 1700; thFilter.Q.value = 0.7;

    oscA = actx.createOscillator(); oscA.type = 'sine';
    oscB = actx.createOscillator(); oscB.type = 'sine'; oscB.detune.value = +6;

    lfoTrem = actx.createOscillator(); lfoTrem.type = 'sine'; lfoTrem.frequency.value = 0.9;
    lfoTremGain = actx.createGain(); lfoTremGain.gain.value = 0.08;

    lfoVib = actx.createOscillator(); lfoVib.type = 'sine'; lfoVib.frequency.value = 5.5;
    lfoVibGain = actx.createGain(); lfoVibGain.gain.value = 7.0;

    oscA.connect(thFilter);
    oscB.connect(thFilter);
    thFilter.connect(envGain);
    envGain.connect(thBus);

    lfoVib.connect(lfoVibGain);
    lfoVibGain.connect(oscA.detune);
    lfoVibGain.connect(oscB.detune);

    lfoTrem.connect(lfoTremGain);
    lfoTremGain.connect(envGain.gain);

    oscA.start(); oscB.start(); lfoTrem.start(); lfoVib.start();
  }

  function resumeAudio(){
    ensureAudio();
    try{ if(actx && actx.state !== 'running') actx.resume(); }catch(_ ){}
  }

  // MIDI note -> Hz
  function n2f(n){ return 440 * Math.pow(2, (n-69)/12); }

  // Melody voice: sine + quiet octave below (recognitionÂÑ™ÂÖà)
  function playNote(n, durSec){
    if(!actx) return;
    const t0 = actx.currentTime;

    const o1 = actx.createOscillator();
    const o2 = actx.createOscillator();
    const g = actx.createGain();
    const lp = actx.createBiquadFilter();

    o1.type = 'sine';
    o2.type = 'sine';
    o1.frequency.value = n2f(n);
    o2.frequency.value = n2f(n-12); // octave below

    lp.type = 'lowpass'; lp.frequency.value = 2600;

    g.gain.setValueAtTime(0.0, t0);
    g.gain.linearRampToValueAtTime(0.90, t0+0.015);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+Math.max(0.06, durSec*0.93));

    const mix = actx.createGain();
    mix.gain.value = 1.0;
    o1.connect(mix);
    const g2 = actx.createGain(); g2.gain.value = 0.22;
    o2.connect(g2).connect(mix);

    mix.connect(lp).connect(g).connect(melodyBus);

    o1.start(t0); o2.start(t0);
    o1.stop(t0 + durSec + 0.02);
    o2.stop(t0 + durSec + 0.02);
  }

  // ===== Songs (recognition priority) =====
  // d: quarter-note units (1 = quarter, 0.5 = eighth, 2 = half)
  const SONGS = {
    star: {
      label:'„Åç„Çâ„Åç„ÇâÊòü', icon:'‚òÜ', tempo:112, type:'star', color:'#facc15',
      // C C G G A A G | F F E E D D C
      seq: [
        {n:60,d:1},{n:60,d:1},{n:67,d:1},{n:67,d:1},{n:69,d:1},{n:69,d:1},{n:67,d:2},
        {n:65,d:1},{n:65,d:1},{n:64,d:1},{n:64,d:1},{n:62,d:1},{n:62,d:1},{n:60,d:2},
        {n:null,d:1}
      ]
    },
    sheep: {
      label:'„É°„É™„Éº„Åï„Çì„ÅÆÁæä', icon:'üêë', tempo:116, type:'sheep', color:'#60a5fa',
      // E D C D | E E E | D D D | E G G | (repeat to lock-in)
      seq: [
        {n:64,d:1},{n:62,d:1},{n:60,d:1},{n:62,d:1},
        {n:64,d:1},{n:64,d:1},{n:64,d:2},
        {n:62,d:1},{n:62,d:1},{n:62,d:2},
        {n:64,d:1},{n:67,d:1},{n:67,d:2},
        {n:64,d:1},{n:62,d:1},{n:60,d:1},{n:62,d:1},
        {n:64,d:1},{n:64,d:1},{n:64,d:2},
        {n:null,d:1}
      ]
    },
    butterfly: {
      label:'„Å°„Çá„ÅÜ„Å°„Çá„ÅÜ', icon:'ü¶ã', tempo:120, type:'butterfly', color:'#a78bfa',
      // „Åù„Åø„Åø„Éº „Åµ„ÅÅ„Çå„Çå„Éº „Å©„Çå„Åø„Åµ„ÅÅ „Åù„Åù„Åù„Éº ...ÔºàÂÆöÁï™„ÅÆÊ≠å„ÅÑÂõû„ÅóÔºâ
      seq: [
        {n:67,d:1},{n:64,d:1},{n:64,d:2},{n:65,d:1},{n:62,d:1},{n:62,d:2},{n:60,d:1},{n:62,d:1},
        {n:64,d:1},{n:65,d:1},{n:67,d:1},{n:67,d:1},{n:67,d:2},{n:67,d:1},{n:64,d:1},{n:64,d:1},
        {n:64,d:1},{n:65,d:1},{n:62,d:1},{n:62,d:1},{n:62,d:1},{n:60,d:1},{n:64,d:1},{n:67,d:1},
        {n:67,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:2},{n:62,d:1},{n:62,d:1},{n:62,d:1},{n:62,d:1},
        {n:62,d:1},{n:64,d:1},{n:65,d:2},{n:64,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:1},
        {n:65,d:1},{n:67,d:2},{n:67,d:1},{n:64,d:1},{n:64,d:1},{n:64,d:1},{n:65,d:1},{n:62,d:1},
        {n:62,d:1},{n:62,d:1},{n:60,d:1},{n:64,d:1},{n:67,d:1},{n:67,d:1},{n:64,d:1},{n:64,d:1},
        {n:64,d:2},
        {n:null,d:1}
      ]
    },
    bee: {
      label:'„Å∂„Çì„Å∂„Çì„Å∂„Çì', icon:'üêù', tempo:126, type:'bee', color:'#34d399',
      // „ÇΩ„Éï„Ç°„Éü „É¨„Éü„Éï„Ç°„É¨„Éâ „Éü„Éï„Ç°„ÇΩ„Éü „É¨„Éü„Éï„Ç°„É¨ ...ÔºàÂÆöÁï™„ÅÆÊ≠å„ÅÑÂõû„ÅóÔºâ
      seq: [
        {n:67,d:0.5},{n:65,d:0.5},{n:64,d:1},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:62,d:0.5},{n:60,d:1},
        {n:64,d:0.5},{n:65,d:0.5},{n:67,d:0.5},{n:64,d:1},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:62,d:1},
        {n:64,d:0.5},{n:65,d:0.5},{n:67,d:0.5},{n:64,d:1},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:62,d:1},
        {n:67,d:0.5},{n:65,d:0.5},{n:64,d:1},{n:62,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:62,d:0.5},{n:60,d:2},
        {n:null,d:1}
      ]
    },
    frog: {
      label:'„Åã„Åà„Çã„ÅÆÂêàÂî±', icon:'üê∏', tempo:118, type:'frog', color:'#34d399',
      // „Éâ„É¨„Éü„Éï„Ç°ÔΩú„Éü„É¨„ÉâÔΩú„Éü„Éï„Ç°„ÇΩ„É©ÔΩú„ÇΩ„Éï„Ç°„ÉüÔΩú„Éâ„ÉâÔΩú„Éâ„ÉâÔΩú„Éâ„Éâ„É¨„É¨„Éü„Éü„Éï„Ç°„Éï„Ç°ÔΩú„Éü„É¨„Éâ
      seq: [
        {n:60,d:1},{n:62,d:1},{n:64,d:1},{n:65,d:1},{n:64,d:1},{n:62,d:1},{n:60,d:2},
        {n:64,d:1},{n:65,d:1},{n:67,d:1},{n:69,d:1},{n:67,d:1},{n:65,d:1},{n:64,d:2},
        {n:60,d:1},{n:60,d:1},{n:60,d:1},{n:60,d:1},
        {n:60,d:0.5},{n:60,d:0.5},{n:62,d:0.5},{n:62,d:0.5},{n:64,d:0.5},{n:64,d:0.5},{n:65,d:0.5},{n:65,d:0.5},
        {n:64,d:1},{n:62,d:1},{n:60,d:2},
        {n:null,d:1}
      ]
    },
    bear: {
      label:'Ê£Æ„ÅÆ„Åè„Åæ„Åï„Çì', icon:'üêª', tempo:120, type:'bear', color:'#f472b6',
      // („Çà„Åè‰Ωø„Çè„Çå„ÇãÊóãÂæã„ÅÆÁâπÂæ¥„ÇíÂÑ™ÂÖà„Åó„Å¶„ÄÅÂçäÈü≥„ÇíÂê´„ÇÄÂΩ¢„ÅßÂõ∫ÂÆö)
      // „ÇΩ „Éï„Ç°# „ÇΩ „Éü „Éü „É¨# „Éü „Éâ „Éü„É¨„Éâ„É¨ „ÇΩ„É©„ÇΩ„Éü „ÇΩ„É©„Ç∑„Éâ„ÇΩ„Éü„Éâ„É© „É©„Ç∑„É©„ÇΩ„Éï„Ç°„Éü„É¨„Éâ
      seq: [
        {n:67,d:0.5},{n:66,d:0.5},{n:67,d:0.5},{n:64,d:0.5},{n:64,d:0.5},{n:63,d:0.5},{n:64,d:0.5},{n:60,d:1},
        {n:64,d:0.5},{n:62,d:0.5},{n:60,d:0.5},{n:62,d:0.5},
        {n:67,d:0.5},{n:69,d:0.5},{n:67,d:0.5},{n:64,d:1},
        {n:67,d:0.5},{n:69,d:0.5},{n:71,d:0.5},{n:72,d:0.5},{n:67,d:0.5},{n:64,d:0.5},{n:60,d:0.5},{n:69,d:0.5},
        {n:69,d:0.5},{n:71,d:0.5},{n:69,d:0.5},{n:67,d:0.5},{n:65,d:0.5},{n:64,d:0.5},{n:62,d:0.5},{n:60,d:1},
        {n:null,d:1}
      ]
    }
  };
  const SONG_KEYS = Object.keys(SONGS);

  function stopSong(){
    if(seqTimer){ clearTimeout(seqTimer); seqTimer=null; }
    seqPos = 0;
  }

  function setActiveButton(songKey){
    songButtons.forEach(b=>b.classList.toggle('active', b.dataset.song===songKey));
  }

  function updateEmoji(){
    const ic = SONGS[currentSong]?.icon || '‚òÜ';
    emojiFallback.textContent = ic;
    emojiFallback.classList.add('show');
  }

  function startSong(songKey){
    resumeAudio();
    stopSong();
    currentSong = songKey;
    setActiveButton(songKey);
    updateEmoji();
    resetShapes();

    const song = SONGS[songKey];
    const beatSec = 60 / song.tempo;

    (function tick(){
      if(!currentSong) return;
      const item = song.seq[seqPos % song.seq.length];
      const dur = (item.d||1) * beatSec;
      if(item.n!=null) playNote(item.n, dur*0.98);
      seqPos++;
      seqTimer = setTimeout(tick, Math.max(20, dur*1000));
    })();
  }

  function randomStart(){
    const k = SONG_KEYS[(Math.random()*SON_KEYS.length)|0];
    startSong(k);
  }

  // ===== Visuals =====
  const COLORS = ['#60a5fa','#f472b6','#facc15','#a78bfa','#34d399'];
  const SHAPE_COUNT = 22;
  const LINE_BASE = 7;
  const GLOW = 44;
  const BEAT_AMT = 0.18;

  let shapes = [];
  let t=0;
  let drawnOnce=false;

  function resetShapes(){
    shapes.length=0;
    const type = SONGS[currentSong]?.type || 'star';
    for(let i=0;i<SHAPE_COUNT;i++){
      const r = 70*(0.6+Math.random()*0.6);
      const x = Math.random()*cv.width;
      const y = Math.random()*cv.height;
      const rot = Math.random()*Math.PI*2;
      const vx = (Math.random()-0.5)*0.55;
      const vy = (Math.random()-0.5)*0.55;
      const color = (SONGS[currentSong]?.color) || COLORS[i%COLORS.length];
      shapes.push({type,x,y,r,rot,vx,vy,pulse:0,color});
    }
  }

  function burstAt(px,py){
    for(const s of shapes){
      const ang = Math.atan2(s.y-py, s.x-px);
      const f = 4.5 + Math.random()*3.0;
      s.vx += Math.cos(ang)*f;
      s.vy += Math.sin(ang)*f;
      s.pulse = Math.min(1.5, s.pulse+1.2);
    }
  }

  function getCanvasPos(e){
    const r = cv.getBoundingClientRect();
    const x = (e.clientX-r.left)/r.width*cv.width;
    const y = (e.clientY-r.top)/r.height*cv.height;
    if(Number.isFinite(x) && Number.isFinite(y)) return {x,y};
    return null;
  }

  function strokeNeon(drawFn, color){
    ctx.save();
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.shadowColor = color;
    ctx.shadowBlur = GLOW*2.2;
    ctx.strokeStyle = color;
    ctx.lineWidth = LINE_BASE*2.6;
    drawFn(); ctx.stroke();
    ctx.shadowBlur = GLOW*0.8;
    ctx.lineWidth = LINE_BASE*1.6;
    drawFn(); ctx.stroke();
    ctx.shadowBlur = 0;
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = Math.max(1, LINE_BASE*0.7);
    drawFn(); ctx.stroke();
    ctx.restore();
  }

  function pathStar(r){
    ctx.beginPath();
    for(let i=0;i<5;i++){
      const a = i*2*Math.PI/5 - Math.PI/2;
      const b = a + Math.PI/5;
      if(i===0) ctx.moveTo(Math.cos(a)*r, Math.sin(a)*r);
      else ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
      ctx.lineTo(Math.cos(b)*r*0.42, Math.sin(b)*r*0.42);
    }
    ctx.closePath();
  }
  function pathButterfly(r){
    ctx.beginPath();
    ctx.moveTo(0, -r*0.9);
    ctx.quadraticCurveTo(r*0.10, 0, 0, r*0.9);
    ctx.quadraticCurveTo(-r*0.10, 0, 0, -r*0.9);
    ctx.moveTo(0, -r*0.15);
    ctx.bezierCurveTo(-r*1.05, -r*1.00, -r*1.15, r*0.45, 0, r*0.55);
    ctx.moveTo(0, -r*0.15);
    ctx.bezierCurveTo(r*1.05, -r*1.00, r*1.15, r*0.45, 0, r*0.55);
  }
  function pathSheep(r){
    ctx.beginPath();
    const rr = r*0.85;
    const bumps = 10;
    for(let i=0;i<=bumps;i++){
      const a = i*2*Math.PI/bumps;
      const br = rr*(0.88 + 0.12*Math.sin(i*1.7));
      const x = Math.cos(a)*br;
      const y = Math.sin(a)*br*0.78;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.moveTo(r*0.95, r*0.15);
    ctx.ellipse(r*0.82, r*0.15, r*0.35, r*0.28, 0, 0, Math.PI*2);
  }
  function pathBear(r){
    ctx.beginPath();
    ctx.arc(0, 0, r*0.80, 0, Math.PI*2);
    ctx.moveTo(-r*0.45, -r*0.55); ctx.arc(-r*0.60, -r*0.65, r*0.28, 0, Math.PI*2);
    ctx.moveTo(r*0.45, -r*0.55);  ctx.arc(r*0.60, -r*0.65, r*0.28, 0, Math.PI*2);
  }
  function pathBee(r){
    ctx.beginPath();
    ctx.ellipse(0, 0, r*0.85, r*0.55, 0, 0, Math.PI*2);
    for(let i=-1;i<=1;i++){ ctx.moveTo(i*r*0.25, -r*0.45); ctx.lineTo(i*r*0.25, r*0.45); }
    ctx.moveTo(-r*0.10, -r*0.35);
    ctx.ellipse(-r*0.35, -r*0.55, r*0.35, r*0.25, -0.2, 0, Math.PI*2);
    ctx.moveTo(r*0.10, -r*0.35);
    ctx.ellipse(r*0.35, -r*0.55, r*0.35, r*0.25, 0.2, 0, Math.PI*2);
  }
  function pathFrog(r){
    ctx.beginPath();
    ctx.ellipse(0, r*0.15, r*0.78, r*0.62, 0, 0, Math.PI*2);
    ctx.moveTo(-r*0.45, -r*0.45); ctx.arc(-r*0.45, -r*0.45, r*0.18, 0, Math.PI*2);
    ctx.moveTo(r*0.45, -r*0.45);  ctx.arc(r*0.45, -r*0.45, r*0.18, 0, Math.PI*2);
    ctx.moveTo(-r*0.30, r*0.28); ctx.quadraticCurveTo(0, r*0.45, r*0.30, r*0.28);
  }

  function drawOne(type, r){
    const drawFn = () => {
      if(type==='star') pathStar(r);
      else if(type==='butterfly') pathButterfly(r);
      else if(type==='sheep') pathSheep(r);
      else if(type==='bear') pathBear(r);
      else if(type==='bee') pathBee(r);
      else if(type==='frog') pathFrog(r);
      else pathStar(r);
    };
    const c = (SONGS[currentSong]?.color) || '#60a5fa';
    strokeNeon(drawFn, c);
  }

  function getBeatScale(){
    if(!analyser) return 1.0;
    const data = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);
    let sum = 0;
    for(let i=0;i<10;i++) sum += data[i] || 0;
    const beatVal = (sum/10) / 255;
    return 1.0 + beatVal * BEAT_AMT;
  }

  function drawLoop(){
    try{
      paintBG();
      const beatScale = getBeatScale();
      for(const s of shapes){
        s.x += s.vx; s.y += s.vy; s.rot += 0.008;
        const w=cv.width, h=cv.height;
        const rr = s.r;
        if(s.x<rr){ s.x=rr; s.vx=Math.abs(s.vx); }
        if(s.x>w-rr){ s.x=w-rr; s.vx=-Math.abs(s.vx); }
        if(s.y<rr){ s.y=rr; s.vy=Math.abs(s.vy); }
        if(s.y>h-rr){ s.y=h-rr; s.vy=-Math.abs(s.vy); }
        s.vx *= 0.992; s.vy *= 0.992;
        const base = 1 + 0.07*Math.sin(t*0.03 + s.x*0.003) + s.pulse*0.25;
        const size = s.r * base * beatScale;
        s.pulse *= 0.92;
        ctx.save();
        ctx.translate(s.x, s.y);
        ctx.rotate(s.rot);
        drawOne(s.type, size);
        ctx.restore();
      }
      t++;
      if(!drawnOnce){ drawnOnce=true; emojiFallback.classList.remove('show'); }
    }catch(_err){
      emojiFallback.classList.add('show');
    }
    requestAnimationFrame(drawLoop);
  }

  // ===== Interaction =====
  let dragging=false, thereminOn=false, holdId=null, lastPos=null;
  window.pitchHz = 440;

  function setPitchFromYCanvas(y){
    const pmin=120, pmax=900;
    const n = Math.min(1, Math.max(0, y / cv.height));
    const curve = Math.sin((1-n)*Math.PI);
    window.pitchHz = pmin + curve*(pmax-pmin);
    if(actx && oscA && oscB){
      const t0 = actx.currentTime;
      oscA.frequency.setTargetAtTime(window.pitchHz, t0, 0.02);
      oscB.frequency.setTargetAtTime(window.pitchHz, t0, 0.02);
    }
    if(actx && thFilter){
      const t0 = actx.currentTime;
      thFilter.frequency.setTargetAtTime(1400 + curve*1200, t0, 0.06);
    }
  }

  function startTheremin(){
    if(!actx) return;
    thereminOn = true;
    const t0 = actx.currentTime;
    envGain.gain.cancelScheduledValues(t0);
    envGain.gain.setTargetAtTime(1.0, t0, 0.02);
  }
  function stopTheremin(){
    if(!actx) return;
    thereminOn = false;
    const t0 = actx.currentTime;
    envGain.gain.cancelScheduledValues(t0);
    envGain.gain.setTargetAtTime(0.0, t0, 0.10);
  }

  function pluck(){
    if(!actx) return;
    const now = actx.currentTime;
    const o = actx.createOscillator();
    const g = actx.createGain();
    const lp = actx.createBiquadFilter();
    o.type = 'triangle';
    lp.type = 'lowpass'; lp.frequency.value = 2400;
    o.frequency.value = window.pitchHz || 440;
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.9, now+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.28);
    o.connect(lp).connect(g).connect(master);
    o.start(now);
    o.stop(now+0.4);
  }

  cv.addEventListener('pointerdown', (e)=>{
    resumeAudio();
    dragging=true;
    lastPos = getCanvasPos(e);
    if(holdId) clearTimeout(holdId);
    holdId = setTimeout(()=>{ startTheremin(); }, 220);
  }, {passive:false});

  cv.addEventListener('pointermove', (e)=>{
    if(!dragging) return;
    const p = getCanvasPos(e);
    if(p) lastPos = p;
    if(thereminOn && p) setPitchFromYCanvas(p.y);
  }, {passive:false});

  window.addEventListener('pointerup', (e)=>{
    if(!dragging) return;
    dragging=false;
    if(holdId){ clearTimeout(holdId); holdId=null; }
    if(thereminOn){ stopTheremin(); }
    else {
      pluck();
      try{ chime.currentTime=0; chime.play(); }catch(_ ){}
      const p = getCanvasPos(e) || lastPos;
      if(p) burstAt(p.x,p.y);
    }
  }, {passive:false});

  // ===== Start flow =====
  let started=false;
  function startApp(){
    if(started) return;
    started=true;
    if(starter && starter.parentNode) starter.parentNode.removeChild(starter);
    randomStart();
    resetShapes();
    requestAnimationFrame(drawLoop);
  }
  startbtn.addEventListener('click', (e)=>{ e.stopPropagation(); startApp(); });
  songButtons.forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      if(!started) startApp();
      startSong(btn.dataset.song);
    });
  });
})();
</script>
<script>
if("serviceWorker" in navigator){ navigator.serviceWorker.register("./sw.js?v=3.2.3"); }
</script>
</body>
</html>
